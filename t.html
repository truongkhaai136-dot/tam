<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>Transcript (EN + VI) - H·ªó tr·ª£ YouTube & Dailymotion</title>
<style>
    /* CSS c·ªßa b·∫°n gi·ªØ nguy√™n */
    body { font-family: Arial, sans-serif; }
    #player-container { margin-bottom: 15px; width: 640px; height: 360px; background-color: #000; }
    #transcript { max-width: 800px; margin: 0 auto; }
    .line { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; position: relative; }
    .line:hover { background-color: #eef; }
    .user { font-weight: bold; }
    .machine { color: gray; margin-left: 10px; }
    .line[contenteditable="true"] { background-color: #ffffcc; outline: 1px dashed #999; }
    .highlight { background-color: #d1ecf1 !important; }
    .record-btn { position: absolute; right: 10px; top: 8px; background: #2196f3; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .result { margin-top: 5px; font-size: 13px; }
    #toolbar { display: none; position: absolute; background: #fff; border: 1px solid #ccc; padding: 5px; z-index: 1000; }
</style>
<script src="https://api.dmcdn.net/all.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div style="margin: 20px auto; max-width: 800px;">
    <div>
        <label><input type="radio" name="platform" value="youtube" checked> YouTube</label>
        <label><input type="radio" name="platform" value="dailymotion"> Dailymotion</label>
    </div>
    <br>
    <label>üîó Video ID: <input id="videoIdInput" style="width: 300px;" type="text" value=""/></label><br/><br/>
    <label>üìù English Transcript: <textarea id="scriptEN" rows="6" style="width: 100%;"></textarea></label><br/><br/>
    <label>üáªüá≥ Vietnamese Transcript: <textarea id="scriptVI" rows="6" style="width: 100%;"></textarea></label><br/><br/>
    <br/>
    <button onclick="loadVideoAndTranscript()">‚ñ∂Ô∏è Load Video + Transcript</button><br/>
    <button onclick="saveScripts()">üíæ Save Script</button>
    <br/><br/>
    <label>üìÇ Load Saved Script (.json):
      <input type="file" id="loadFileInput" accept=".json" onchange="loadScriptFile(event)">
    </label>
</div>

<div id="player-container">
    <div id="player"></div>
</div>

<h3>Transcript (EN + VI)</h3>
<div id="toolbar">
    <button onclick="execCmd('bold')"><b>B</b></button>
    <button onclick="execCmd('italic')"><i>I</i></button>
    <button onclick="execCmd('underline')"><u>U</u></button>
    <input onchange="execCmd('foreColor', this.value)" type="color"/>
</div>
<div id="transcript"></div>
<button id="togglePause" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 10px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Pause</button>

<script>
    // === PH·∫¶N KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ===
    let player;
    let transcriptData = [];
    let userScrolling = false;
    let scrollTimeout = null;
    let currentPlayerType = null;
    let isPlaying = false;

    // KHAI B√ÅO 2 BI·∫æN C·ªú ƒê·ªÇ KI·ªÇM TRA API S·∫¥N S√ÄNG
    let youtubeApiReady = false;
    let dailymotionApiReady = false;

    // === C√ÅC H√ÄM CH·ªú API T·∫¢I XONG ===
    // H√ÄM CH·ªú C·ª¶A YOUTUBE
    window.onYouTubeIframeAPIReady = function() {
        console.log("YouTube API is ready.");
        youtubeApiReady = true;
    };
    
    // H√ÄM CH·ªú C·ª¶A DAILYMOTION
    window.dmAsyncInit = function() {
        console.log("Dailymotion API is ready.");
        dailymotionApiReady = true;
    };

    // === C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN PLAYER (TR·ª™U T∆Ø·ª¢NG) ===
    function playPlayer() {
        if (!player) return;
        if (currentPlayerType === 'youtube') player.playVideo();
        else if (currentPlayerType === 'dailymotion') player.play();
    }

    function pausePlayer() {
        if (!player) return;
        if (currentPlayerType === 'youtube') player.pauseVideo();
        else if (currentPlayerType === 'dailymotion') player.pause();
    }

    function seekPlayer(time) {
        if (!player) return;
        if (currentPlayerType === 'youtube') player.seekTo(time, true);
        else if (currentPlayerType === 'dailymotion') player.seek(time);
    }

    function getPlayerCurrentTime() {
        if (!player) return 0;
        if (currentPlayerType === 'youtube') return player.getCurrentTime();
        else if (currentPlayerType === 'dailymotion') return player.currentTime;
        return 0;
    }

    function destroyPlayer() {
        if (player) {
            if (currentPlayerType === 'youtube' && typeof player.destroy === 'function') {
                player.destroy();
            }
            document.getElementById('player').innerHTML = "";
        }
        player = null;
        isPlaying = false;
    }

    // === H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN CH√çNH ===
    function onPlayerStateChange(state) {
        // YouTube: state.data == 1 (PLAYING)
        // Dailymotion: ch√∫ng ta s·∫Ω t·ª± g·ªçi v·ªõi state == 'play'
        if (state.data === YT.PlayerState.PLAYING || state === 'play') {
            isPlaying = true;
            document.getElementById('togglePause').textContent = 'Pause';
            requestAnimationFrame(trackCurrentLine);
        } else {
            isPlaying = false;
            document.getElementById('togglePause').textContent = 'Play';
        }
    }

    document.getElementById('togglePause').onclick = function() {
        if (isPlaying) {
            pausePlayer();
        } else {
            playPlayer();
        }
    };

    function trackCurrentLine() {
        if (!isPlaying) return;
        const currentTime = getPlayerCurrentTime();
        let currentId = null;
        for (let i = 0; i < transcriptData.length; i++) {
            const line = transcriptData[i];
            if (currentTime >= line.time && (i === transcriptData.length - 1 || currentTime < transcriptData[i + 1].time)) {
                currentId = line.id;
                break;
            }
        }
        document.querySelectorAll('.line').forEach(el => el.classList.remove('highlight'));
        if (currentId && currentId.startsWith('en_')) {
            const activeEl = document.getElementById(currentId);
            if (activeEl) {
                activeEl.classList.add('highlight');
                if (!userScrolling) {
                    activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        if (isPlaying) {
            requestAnimationFrame(trackCurrentLine);
        }
    }
    
    // === H√ÄM T·∫¢I VIDEO V√Ä TRANSCRIPT (QUAN TR·ªåNG NH·∫§T) ===
    function loadVideoAndTranscript() {
        const videoId = document.getElementById('videoIdInput').value.trim();
        const platform = document.querySelector('input[name="platform"]:checked').value;
        
        if (!videoId) {
            alert('Please enter a Video ID.');
            return;
        }

        destroyPlayer();
        
        const playerContainer = document.getElementById('player-container');
        playerContainer.innerHTML = '<div id="player"></div>';

        currentPlayerType = platform;

        if (platform === 'youtube') {
            // KI·ªÇM TRA YOUTUBE S·∫¥N S√ÄNG
            if (!youtubeApiReady) {
                alert('YouTube API is not ready yet. Please try again in a moment.');
                return;
            }
            player = new YT.Player('player', {
                height: '360', width: '640', videoId: videoId,
                events: { 'onStateChange': onPlayerStateChange }
            });
        } else if (platform === 'dailymotion') {
            // KI·ªÇM TRA DAILYMOTION S·∫¥N S√ÄNG
            if (!dailymotionApiReady) {
                alert('Dailymotion API is not ready yet. Please try again in a moment.');
                return;
            }
            player = DM.player('player', {
                video: videoId, width: '640', height: '360',
                params: { autoplay: false, mute: false }
            });
            player.addEventListener('apiready', () => {
                player.addEventListener('play', () => onPlayerStateChange('play'));
                player.addEventListener('pause', () => onPlayerStateChange('pause'));
                player.addEventListener('end', () => onPlayerStateChange('end'));
            });
        }

        // Ph·∫ßn x·ª≠ l√Ω transcript gi·ªØ nguy√™n
        const rawEN = document.getElementById('scriptEN').value.trim();
        const rawVI = document.getElementById('scriptVI').value.trim();
        const en = parseTranscript(rawEN);
        const vi = parseTranscript(rawVI);
        const transcript = document.getElementById('transcript');
        transcript.innerHTML = '';
        transcriptData = [];

        for (let i = 0; i < Math.max(en.length, vi.length); i++) {
            if (en[i]) {
                const text = `[${Math.floor(en[i].time / 60)}:${(en[i].time % 60).toString().padStart(2, '0')}] ${en[i].text}`;
                const div = createLineCard('en_' + i, en[i].time, text, 'user');
                transcript.appendChild(div);
                transcriptData.push({ id: 'en_' + i, time: en[i].time });
            }
            if (vi[i]) {
                const text = `[VI] ${vi[i].text}`;
                const div = createLineCard('vi_' + i, vi[i].time, text, 'machine');
                transcript.appendChild(div);
            }
        }
    }
    
    // === C√ÅC H√ÄM PH·ª§ TR·ª¢ KH√ÅC (GI·ªÆ NGUY√äN) ===
    function createLineCard(id, time, fallbackText, className) {
        const div = document.createElement('div');
        div.className = `line ${className}`;
        div.dataset.time = time;
        div.id = id;
        div.innerHTML = fallbackText;
        div.onclick = () => seekPlayer(time);
        if (className === 'user') {
            const btn = document.createElement('button');
            btn.className = 'record-btn';
            btn.textContent = 'üé§';
            btn.onclick = (e) => {
                e.stopPropagation();
                startSpeechRecognition(div, fallbackText);
            };
            div.appendChild(btn);
        }
        return div;
    }
    function parseTranscript(raw) {
        const lines = raw.trim().split('\n');
        const parsed = [];
        let currentTime = null, currentText = [];
        for (const line of lines) {
            const match = line.match(/^(\d+):(\d{2})$/);
            if (match) {
                if (currentTime !== null && currentText.length)
                    parsed.push({ time: currentTime, text: currentText.join('<br>') });
                currentTime = parseInt(match[1]) * 60 + parseInt(match[2]);
                currentText = [];
            } else {
                currentText.push(line.trim());
            }
        }
        if (currentTime !== null && currentText.length)
            parsed.push({ time: currentTime, text: currentText.join('<br>') });
        return parsed;
    }
    document.getElementById('transcript').addEventListener('wheel', () => {
        userScrolling = true;
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => userScrolling = false, 9000);
    });
    document.addEventListener('dblclick', e => {
        if (e.target.classList.contains('line')) {
            e.target.contentEditable = true;
            e.target.focus();
        }
    });
    document.addEventListener('mouseup', e => {
        const sel = window.getSelection();
        if (sel.toString().length > 0) {
            const rect = sel.getRangeAt(0).getBoundingClientRect();
            const toolbar = document.getElementById('toolbar');
            toolbar.style.top = `${window.scrollY + rect.top - 40}px`;
            toolbar.style.left = `${window.scrollX + rect.left}px`;
            toolbar.style.display = 'block';
        } else {
            document.getElementById('toolbar').style.display = 'none';
        }
    });
    function execCmd(cmd, value = null) {
        document.execCommand(cmd, false, value);
    }
    function startSpeechRecognition(div, expectedText) {
        const oldResult = div.querySelector('.result');
        if (oldResult) oldResult.remove();
        const oldPlayback = div.querySelector('.playback-container');
        if (oldPlayback) oldPlayback.remove();
        if (!('webkitSpeechRecognition' in window) || !navigator.mediaDevices) {
            alert('Speech recognition or recording not supported in this browser');
            return;
        }
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const playbackContainer = document.createElement('div');
                    playbackContainer.className = 'playback-container';
                    const listenButton = document.createElement('button');
                    listenButton.textContent = '‚ñ∂Ô∏è Listen Again';
                    listenButton.style.marginTop = '5px';
                    listenButton.onclick = () => new Audio(audioUrl).play();
                    playbackContainer.appendChild(listenButton);
                    div.appendChild(playbackContainer);
                };
                mediaRecorder.start();
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.onend = () => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                };
                recognition.onresult = function(event) {
                    const spokenText = event.results[0][0].transcript;
                    const cleanExpected = expectedText.replace(/\[\d+:\d{2}\]\s*/, '').trim();
                    const score = similarity(spokenText.toLowerCase(), cleanExpected.toLowerCase());
                    const resultEl = document.createElement('div');
                    resultEl.className = 'result';
                    resultEl.innerHTML = `You said: "<em>${spokenText}</em>" ‚Üí Similarity: <b>${Math.round(score * 100)}%</b>`;
                    div.appendChild(resultEl);
                };
                recognition.onerror = function(event) {
                    alert('Error occurred in recognition: ' + event.error);
                    mediaRecorder.stop();
                };
                recognition.start();
            })
            .catch(err => {
                alert('Could not access the microphone. Please grant permission.');
                console.error("Error accessing microphone:", err);
            });
    }
    function similarity(s1, s2) {
        let longer = s1;
        let shorter = s2;
        if (s1.length < s2.length) {
            longer = s2;
            shorter = s1;
        }
        let longerLength = longer.length;
        if (longerLength === 0) {
            return 1.0;
        }
        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }
    function editDistance(s1, s2) {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();
        let costs = new Array();
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i == 0) {
                    costs[j] = j;
                } else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) != s2.charAt(j - 1))
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
            }
            if (i > 0)
                costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }
    function saveScripts() {
        const videoId = document.getElementById('videoIdInput').value.trim();
        const lines = document.querySelectorAll('.line');
        const enChunks = [];
        const viChunks = [];
        for (const line of lines) {
            const time = parseInt(line.dataset.time || '0');
            const minutes = Math.floor(time / 60);
            const seconds = (time % 60).toString().padStart(2, '0');
            let content = line.innerHTML
                .replace(/<button[^>]*>.*?<\/button>/g, '')
                .replace(/<div class="result">.*?<\/div>/g, '')
                .replace(/<div class="playback-container">.*?<\/div>/g, '')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<[^>]+>/g, '')
                .replace(/\n{2,}/g, '\n')
                .trim();
            let block;
            if (line.classList.contains('user')) {
                const cleanContent = content.replace(/^\[\d+:\d{2}\]\s*/, '');
                block = `${minutes}:${seconds}\n${cleanContent}`;
                enChunks.push(block);
            } else if (line.classList.contains('machine')) {
                const cleanContent = content.replace(/^\[VI\]\s*/, '');
                block = `${minutes}:${seconds}\n${cleanContent}`;
                viChunks.push(block);
            }
        }
        const blob = new Blob([JSON.stringify({
            videoId,
            enText: enChunks.join('\n\n'),
            viText: viChunks.join('\n\n')
        }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `transcript_${videoId || 'video'}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    function loadScriptFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                document.getElementById('videoIdInput').value = data.videoId || '';
                document.getElementById('scriptEN').value = data.enText || '';
                document.getElementById('scriptVI').value = data.viText || '';
            } catch (err) {
                alert('Invalid JSON file.');
            }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>