<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Transcript Sync (Minimal Version)</title>
<style>
    body { font-family: sans-serif; padding: 20px; }
    #player { margin-bottom: 20px; max-width: 800px; }
    #transcript { max-width: 800px; border-left: 2px solid #eee; padding-left: 15px; }
    .line { padding: 8px; cursor: pointer; border-radius: 5px; }
    .line:hover { background-color: #f0f0f0; }
    .highlight { background-color: #d1ecf1 !important; font-weight: bold; }
    textarea { width: 100%; box-sizing: border-box; }
    input { width: 300px; }
    button { padding: 8px 15px; margin-top: 10px; }
</style>
<script src="https://geo.dailymotion.com/player.js"></script>
</head>
<body>

<h1>Transcript Synchronizer (Minimal)</h1>
<div>
    <label>Dailymotion Video ID:</label><br>
    <input id="videoIdInput" type="text" value="x7o5w0w">
</div>
<br>
<div>
    <label>Transcript:</label><br>
    <textarea id="scriptInput" rows="8">0:03
The timer has started.
0:07
We are now at seven seconds.
0:12
Passing twelve seconds.
0:15
Fifteen seconds have passed.
0:20
And now twenty.</textarea>
</div>
<button onclick="loadVideoAndTranscript()">▶️ Load and Sync</button>

<div id="player"></div>
<div id="transcript"></div>

<script>
    let player;
    let transcriptData = [];
    let isPlaying = false;

    // Bắt đầu vòng lặp đồng bộ khi video phát
    function onPlayerStateChange() {
        isPlaying = true;
        requestAnimationFrame(trackCurrentLine);
    }

    // Vòng lặp chính để theo dõi và tô sáng
    function trackCurrentLine() {
        if (!player || !isPlaying) return;

        const currentTime = player.currentTime;
        let currentId = null;

        for (let i = 0; i < transcriptData.length; i++) {
            const line = transcriptData[i];
            const isLastLine = (i === transcriptData.length - 1);
            if (currentTime >= line.time && (isLastLine || currentTime < transcriptData[i + 1].time)) {
                currentId = line.id;
                break;
            }
        }

        document.querySelectorAll('.line').forEach(el => el.classList.remove('highlight'));
        if (currentId) {
            const activeEl = document.getElementById(currentId);
            if (activeEl) {
                activeEl.classList.add('highlight');
                activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        if (isPlaying) {
            requestAnimationFrame(trackCurrentLine);
        }
    }

    // Phân tích văn bản lời thoại thành dữ liệu
    function parseTranscript(rawText) {
        const lines = rawText.trim().split('\n');
        const parsed = [];
        let currentTime = null;
        let currentText = [];

        for (const line of lines) {
            const match = line.match(/^(\d+):(\d{2})$/);
            if (match) {
                if (currentTime !== null && currentText.length) {
                    parsed.push({ time: currentTime, text: currentText.join(' ') });
                }
                currentTime = parseInt(match[1]) * 60 + parseInt(match[2]);
                currentText = [];
            } else if (line.trim()) {
                currentText.push(line.trim());
            }
        }
        if (currentTime !== null && currentText.length) {
            parsed.push({ time: currentTime, text: currentText.join(' ') });
        }
        return parsed;
    }

    // Hàm chính để tải video và lời thoại
    async function loadVideoAndTranscript() {
        const videoId = document.getElementById('videoIdInput').value.trim();
        const rawScript = document.getElementById('scriptInput').value.trim();
        if (!videoId || !rawScript) {
            alert('Please provide both a video ID and a transcript.');
            return;
        }

        // Tạo hoặc tải lại video
        if (!player) {
            try {
                player = await dailymotion.createPlayer('player', {
                    video: videoId,
                    width: '800',
                    height: '450',
                    params: { origin: window.location.origin }
                });
                player.on('play', onPlayerStateChange);
                player.on('pause', () => isPlaying = false);
                player.on('end', () => isPlaying = false);
            } catch (e) {
                console.error("Error creating player:", e);
                alert("Could not create player. Check the console (F12) for errors.");
                return;
            }
        } else {
            player.load({ video: videoId });
        }

        // Xử lý và hiển thị lời thoại
        const parsedScript = parseTranscript(rawScript);
        const transcriptContainer = document.getElementById('transcript');
        transcriptContainer.innerHTML = '';
        transcriptData = [];

        parsedScript.forEach((line, index) => {
            const lineId = `line_${index}`;
            transcriptData.push({ id: lineId, time: line.time });

            const div = document.createElement('div');
            div.className = 'line';
            div.id = lineId;
            div.textContent = `[${Math.floor(line.time / 60)}:${(line.time % 60).toString().padStart(2, '0')}] ${line.text}`;
            div.onclick = () => player.seek(line.time);
            transcriptContainer.appendChild(div);
        });
    }
</script>

</body>
</html>
