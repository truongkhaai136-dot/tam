<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcript Player</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header, .controls, .transcript-area {
            padding: 20px;
        }
        .header {
            background-color: #1877f2;
            color: white;
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        .controls {
            background-color: #f7f8fa;
            border-bottom: 1px solid #dddfe2;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #1877f2;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #166fe5;
        }
        #player-container {
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background: black;
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .transcript-area {
            max-height: 400px;
            overflow-y: auto;
        }
        .line {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            line-height: 1.5;
        }
        .line:hover {
            background-color: #f0f2f5;
        }
        .highlight {
            background-color: #e7f3ff !important;
            color: #1877f2;
            font-weight: 600;
        }
        #status {
            padding: 10px 20px;
            font-weight: 500;
            text-align: center;
        }
        .status-error { color: #fa383e; }
        .status-ok { color: #00a400; }
    </style>
    <script src="https://geo.dailymotion.com/player.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Dailymotion Transcript Player</h1>
    </div>

    <div class="controls">
        <label for="videoIdInput">Dailymotion Video ID</label>
        <input id="videoIdInput" type="text" placeholder="Ví dụ: x7z3k6i">

        <label for="scriptEN">Transcript (định dạng phút:giây)</label>
        <textarea id="scriptEN" rows="6" placeholder="0:01&#10;Dòng transcript đầu tiên&#10;0:05&#10;Dòng transcript thứ hai..."></textarea>

        <button id="loadBtn">▶️ Tải Video & Script</button>
        <div id="status"></div>
    </div>

    <div id="player-container">
        <div id="player"></div>
    </div>

    <div class="transcript-area">
        <div id="transcript"></div>
    </div>
</div>

<script>
    const loadBtn = document.getElementById('loadBtn');
    const videoIdInput = document.getElementById('videoIdInput');
    const scriptENInput = document.getElementById('scriptEN');
    const transcriptContainer = document.getElementById('transcript');
    const statusDiv = document.getElementById('status');
    const playerDiv = document.getElementById('player');

    let player;
    let transcriptData = [];
    let isPlaying = false;
    let animationFrameId;

    function updateStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.className = isError ? 'status-error' : 'status-ok';
    }

    function parseTranscript(rawText) {
        const lines = rawText.trim().split('\n');
        const data = [];
        let currentTime = null;
        let currentText = [];

        for (const line of lines) {
            const timeMatch = line.match(/^(\d+):(\d{2})$/);
            if (timeMatch) {
                if (currentTime !== null && currentText.length > 0) {
                    data.push({ time: currentTime, text: currentText.join('<br>') });
                }
                currentTime = parseInt(timeMatch[1], 10) * 60 + parseInt(timeMatch[2], 10);
                currentText = [];
            } else if (line.trim()) {
                currentText.push(line.trim());
            }
        }
        if (currentTime !== null && currentText.length > 0) {
            data.push({ time: currentTime, text: currentText.join('<br>') });
        }
        return data;
    }

    function syncTranscript() {
        if (!player || !isPlaying) return;

        const currentTime = player.currentTime;
        if (typeof currentTime !== 'number') {
            animationFrameId = requestAnimationFrame(syncTranscript);
            return;
        }

        let currentLineId = null;
        for (let i = 0; i < transcriptData.length; i++) {
            const line = transcriptData[i];
            if (currentTime >= line.time && (i === transcriptData.length - 1 || currentTime < transcriptData[i + 1].time)) {
                currentLineId = `line-${i}`;
                break;
            }
        }

        const currentHighlight = document.querySelector('.highlight');
        if (!currentHighlight || currentHighlight.id !== currentLineId) {
            if (currentHighlight) {
                currentHighlight.classList.remove('highlight');
            }
            if (currentLineId) {
                const newLine = document.getElementById(currentLineId);
                if (newLine) {
                    newLine.classList.add('highlight');
                    newLine.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                }
            }
        }
        animationFrameId = requestAnimationFrame(syncTranscript);
    }

    async function initializePlayer() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        isPlaying = false;

        const videoId = videoIdInput.value.trim();
        const scriptText = scriptENInput.value.trim();

        if (!videoId) {
            updateStatus('Lỗi: Vui lòng nhập Video ID.', true);
            return;
        }
        if (!scriptText) {
            updateStatus('Lỗi: Vui lòng nhập transcript.', true);
            return;
        }

        transcriptData = parseTranscript(scriptText);
        if (transcriptData.length === 0) {
            updateStatus('Lỗi: Script không hợp lệ. Hãy chắc chắn có mốc thời gian (ví dụ: 0:05).', true);
            return;
        }

        updateStatus('Đang tải...', false);

        transcriptContainer.innerHTML = '';
        transcriptData.forEach((line, index) => {
            const div = document.createElement('div');
            div.id = `line-${index}`;
            div.className = 'line';
            div.dataset.time = line.time;
            div.innerHTML = `<strong>[${Math.floor(line.time / 60)}:${(line.time % 60).toString().padStart(2, '0')}]</strong> ${line.text}`;
            div.onclick = () => player?.seek(line.time);
            transcriptContainer.appendChild(div);
        });
        
        try {
            if (player) {
                await player.load(videoId);
            } else {
                player = await dailymotion.createPlayer(playerDiv, { video: videoId });
                player.on('play', () => { isPlaying = true; syncTranscript(); });
                player.on('pause', () => { isPlaying = false; });
                player.on('end', () => { isPlaying = false; });
            }
            updateStatus('Tải thành công! Sẵn sàng phát video.', false);
        } catch (e) {
            updateStatus('Lỗi: Không thể tải video. Vui lòng kiểm tra lại Video ID.', true);
            console.error(e);
        }
    }

    loadBtn.addEventListener('click', initializePlayer);
</script>

</body>
</html>
