<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>Transcript Player (Final Version)</title>
<style>
    body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #player { margin-bottom: 15px; }
    .line { padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer; transition: background-color 0.2s; }
    .line:hover { background-color: #eef; }
    .highlight { background-color: #d1ecf1 !important; font-weight: bold; }
    #status-box { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
    .status-ok { background-color: #e8f5e9; color: #2e7d32; }
    .status-error { background-color: #ffebee; color: #c62828; }
    .status-info { background-color: #e3f2fd; color: #1565c0; }
    textarea, input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px 15px; border: none; border-radius: 5px; background-color: #1a73e8; color: white; cursor: pointer; font-size: 14px; margin-right: 10px; }
    button:hover { background-color: #185abc; }
</style>
<script src="https://geo.dailymotion.com/player.js"></script>
</head>
<body>

<div class="container">
    <h2>Tr√¨nh Ph√°t Transcript</h2>
    <label>üîó Dailymotion Video ID: <input id="videoIdInput" type="text" value=""/></label><br/><br/>
    <label>üìù English Transcript: <textarea id="scriptEN" rows="5"></textarea></label><br/><br/>
    <button onclick="loadVideoAndTranscript()">‚ñ∂Ô∏è Load Video + Transcript</button>
    <div id="status-box" class="status-info">Tr·∫°ng th√°i: S·∫µn s√†ng. Vui l√≤ng nh·∫≠p ID v√† script.</div>
    <hr>
    <div id="player"></div>
    <div id="transcript"></div>
</div>

<script>
    let player;
    let transcriptData = [];
    let isPlaying = false;
    let animationFrameId;

    const statusBox = () => document.getElementById('status-box');

    function updateStatus(message, type = 'info') {
        const box = statusBox();
        box.textContent = `Tr·∫°ng th√°i: ${message}`;
        box.className = 'status-box'; // Reset classes
        if (type === 'ok') box.classList.add('status-ok');
        else if (type === 'error') box.classList.add('status-error');
        else box.classList.add('status-info');
    }

    function trackCurrentLine() {
        if (!player || !isPlaying) {
            return;
        }

        const currentTime = player.currentTime;
        if (typeof currentTime !== 'number') {
            updateStatus('Kh√¥ng th·ªÉ l·∫•y th·ªùi gian video.', 'error');
            return; // Stop the loop if time is invalid
        }
        
        let currentId = null;
        for (let i = 0; i < transcriptData.length; i++) {
            const line = transcriptData[i];
            if (currentTime >= line.time && (i === transcriptData.length - 1 || currentTime < transcriptData[i + 1].time)) {
                currentId = line.id;
                break;
            }
        }
        
        // Only update DOM if the active line changes
        const activeElement = document.querySelector('.highlight');
        const activeId = activeElement ? activeElement.id : null;

        if (currentId !== activeId) {
            if (activeElement) {
                activeElement.classList.remove('highlight');
            }

            if (currentId) {
                const newActiveEl = document.getElementById(currentId);
                if (newActiveEl) {
                    newActiveEl.classList.add('highlight');
                    newActiveEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    updateStatus(`ƒêang ph√°t ·ªü gi√¢y ${currentTime.toFixed(1)}s. Hi·ªÉn th·ªã d√≤ng: ${currentId}.`, 'ok');
                }
            } else {
                 updateStatus(`ƒêang ph√°t ·ªü gi√¢y ${currentTime.toFixed(1)}s. Ch·ªù m·ªëc th·ªùi gian ti·∫øp theo...`, 'info');
            }
        }
        
        animationFrameId = requestAnimationFrame(trackCurrentLine);
    }

    function parseTranscript(rawText) {
        const lines = rawText.trim().split('\n');
        const parsedData = [];
        let currentTime = null;
        let currentText = [];

        for (const line of lines) {
            const match = line.match(/^(\d+):(\d{2})$/);
            if (match) {
                if (currentTime !== null && currentText.length > 0) {
                    parsedData.push({ time: currentTime, text: currentText.join('<br>') });
                }
                currentTime = parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
                currentText = [];
            } else if (line.trim()) {
                currentText.push(line.trim());
            }
        }
        if (currentTime !== null && currentText.length > 0) {
            parsedData.push({ time: currentTime, text: currentText.join('<br>') });
        }
        return parsedData;
    }

    async function loadVideoAndTranscript() {
        updateStatus('ƒêang t·∫£i...', 'info');
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        isPlaying = false;

        const videoId = document.getElementById('videoIdInput').value.trim();
        if (!videoId) {
            updateStatus('Vui l√≤ng nh·∫≠p Video ID.', 'error');
            return;
        }

        const rawEN = document.getElementById('scriptEN').value.trim();
        if (!rawEN) {
            updateStatus('Vui l√≤ng nh·∫≠p n·ªôi dung script.', 'error');
            return;
        }

        transcriptData = parseTranscript(rawEN);
        if (transcriptData.length === 0) {
            updateStatus('Script kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ m·ªëc th·ªùi gian (ph√∫t:gi√¢y).', 'error');
            return;
        }

        const transcriptContainer = document.getElementById('transcript');
        transcriptContainer.innerHTML = '';
        transcriptData.forEach((line, index) => {
            const div = document.createElement('div');
            div.className = 'line';
            div.id = `en_${index}`;
            div.dataset.time = line.time;
            div.innerHTML = `<strong>[${Math.floor(line.time / 60)}:${(line.time % 60).toString().padStart(2, '0')}]</strong> ${line.text}`;
            div.onclick = () => player?.seek(line.time);
            transcriptContainer.appendChild(div);
        });

        try {
            if (player) {
                await player.load(videoId);
            } else {
                player = await dailymotion.createPlayer('player', { video: videoId, width: '100%' });
                
                player.on('play', () => {
                    isPlaying = true;
                    updateStatus('Video ƒëang ph√°t.', 'ok');
                    trackCurrentLine();
                });

                player.on('pause', () => {
                    isPlaying = false;
                    updateStatus('Video ƒë√£ t·∫°m d·ª´ng.', 'info');
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                });

                player.on('end', () => {
                    isPlaying = false;
                    updateStatus('Video ƒë√£ k·∫øt th√∫c.', 'info');
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                });
            }
            updateStatus('T·∫£i video v√† script th√†nh c√¥ng. S·∫µn s√†ng ph√°t.', 'ok');
        } catch (e) {
            console.error(e);
            updateStatus(`L·ªói khi t·∫£i video: ${e.message}. Ki·ªÉm tra l·∫°i Video ID.`, 'error');
        }
    }
</script>

</body>
</html>
