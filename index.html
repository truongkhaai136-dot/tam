<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Transcript (EN + VI) - Dailymotion Version</title>
<style>
    body { font-family: Arial, sans-serif; }
    #player { margin-bottom: 15px; max-width: 800px; margin-left: auto; margin-right: auto; }
    #transcript { max-width: 800px; margin: 0 auto; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    .line { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; position: relative; }
    .line:hover { background-color: #eef; }
    .user { font-weight: bold; }
    .machine { color: gray; margin-left: 10px; }
    .highlight { background-color: #d1ecf1 !important; }
</style>
<script src="https://geo.dailymotion.com/player.js"></script>
</head>
<body>
<div style="margin: 20px auto; max-width: 800px; text-align: center;">
    <p>Bấm nút Load để tải video và script mẫu.</p>
    <button onclick="loadVideoAndTranscript()">▶️ Load Video + Transcript</button>
</div>

<div id="player"></div>

<div style="max-width: 800px; margin: 0 auto;">
    <h3>Transcript (EN + VI)</h3>
    <div id="transcript"></div>
</div>

<button id="togglePause" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Play</button>

<script>
  let player;
  let transcriptData = [];
  let userScrolling = false;
  let scrollTimeout = null;
  let isPlaying = false;

  function trackCurrentLine() {
    if (!player || !isPlaying) return;
    const currentTime = player.currentTime;
    if (typeof currentTime !== 'number') {
      if (isPlaying) requestAnimationFrame(trackCurrentLine);
      return;
    }
    let currentId = null;
    for (let i = 0; i < transcriptData.length; i++) {
      const line = transcriptData[i];
      if (currentTime >= line.time && (i === transcriptData.length - 1 || currentTime < transcriptData[i + 1].time)) {
        currentId = line.id;
        break;
      }
    }
    document.querySelectorAll('.line').forEach(el => el.classList.remove('highlight'));
    if (currentId) {
      let highlightId = currentId.startsWith('vi_') ? currentId.replace('vi_', 'en_') : currentId;
      const activeEl = document.getElementById(highlightId);
      if (activeEl) {
        activeEl.classList.add('highlight');
        if (!userScrolling) {
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
    if (isPlaying) {
      requestAnimationFrame(() => trackCurrentLine());
    }
  }

  function parseTranscript(raw) {
    const lines = raw.trim().split('\n');
    const parsed = [];
    let currentTime = null, currentText = [];
    for (const line of lines) {
      const match = line.match(/^(\d+):(\d{2})$/);
      if (match) {
        if (currentTime !== null && currentText.length)
          parsed.push({ time: currentTime, text: currentText.join('<br>') });
        currentTime = parseInt(match[1]) * 60 + parseInt(match[2]);
        currentText = [];
      } else {
        currentText.push(line.trim());
      }
    }
    if (currentTime !== null && currentText.length)
      parsed.push({ time: currentTime, text: currentText.join('<br>') });
    return parsed;
  }

  function createLineCard(id, time, fallbackText, className) {
    const div = document.createElement('div');
    div.className = `line ${className}`;
    div.dataset.time = time;
    div.id = id;
    div.innerHTML = fallbackText;
    div.onclick = () => { if (player?.seek) player.seek(time); };
    return div;
  }

  // ==========================================================
  // HÀM ĐÃ ĐƯỢC TỐI GIẢN VÀ NHÚNG SẴN DỮ LIỆU
  // ==========================================================
  async function loadVideoAndTranscript() {
    // --- DỮ LIỆU MẪU ĐƯỢC NHÚNG SẴN ---
    const videoId = 'x8on52v'; // Video mẫu (Nature)
    const rawEN = `0:02
This is the first line of the transcript.
0:05
Here comes the second line after a short pause.
0:08
And this is the final line.`;
    const rawVI = `0:02
Đây là dòng đầu tiên của bản ghi.
0:05
Dòng thứ hai xuất hiện sau một khoảng dừng ngắn.
0:08
Và đây là dòng cuối cùng.`;
    // --- KẾT THÚC DỮ LIỆU MẪU ---

    if (player) {
        player.load(videoId);
    } else {
      try {
        player = await dailymotion.createPlayer('player', {
          video: videoId,
          width: '100%',
          height: '450',
          params: { origin: '*' }
        });
        const toggleBtn = document.getElementById('togglePause');
        toggleBtn.onclick = function () {
          if (!player) return;
          if (isPlaying) player.pause();
          else player.play();
        };
        player.on('play', () => {
          isPlaying = true;
          toggleBtn.textContent = 'Pause';
          toggleBtn.style.backgroundColor = '#28a745';
          requestAnimationFrame(() => trackCurrentLine());
        });
        player.on('pause', () => {
          isPlaying = false;
          toggleBtn.textContent = 'Play';
          toggleBtn.style.backgroundColor = '#f44336';
        });
        player.on('end', () => {
          isPlaying = false;
          toggleBtn.textContent = 'Play';
          toggleBtn.style.backgroundColor = '#6c757d';
        });
      } catch (e) {
        console.error("Error creating Dailymotion player:", e);
        return;
      }
    }
    
    const en = parseTranscript(rawEN);
    const vi = parseTranscript(rawVI);
    const transcript = document.getElementById('transcript');
    transcript.innerHTML = '';
    transcriptData = [];
    for (let i = 0; i < Math.max(en.length, vi.length); i++) {
      if (en[i]) {
        const text = `[${Math.floor(en[i].time / 60)}:${(en[i].time % 60).toString().padStart(2, '0')}] ${en[i].text}`;
        const div = createLineCard('en_' + i, en[i].time, text, 'user');
        transcript.appendChild(div);
        transcriptData.push({ id: 'en_' + i, time: en[i].time });
      }
      if (vi[i]) {
        const text = `[VI] ${vi[i].text}`;
        const div = createLineCard('vi_' + i, vi[i].time, text, 'machine');
        transcript.appendChild(div);
        transcriptData.push({ id: 'vi_' + i, time: vi[i].time });
      }
    }
    transcriptData.sort((a, b) => a.time - b.time);
  }

  document.getElementById('transcript').addEventListener('wheel', () => {
    userScrolling = true;
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => userScrolling = false, 3000);
  });
</script>
</body>
</html>
