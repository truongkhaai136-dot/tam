<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Transcript (EN + VI)</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #player-container { margin-bottom: 15px; width: 640px; height: 360px; background-color: #000; }
        #transcript { max-width: 800px; margin: 0 auto; }
        .line { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; position: relative; }
        .line:hover { background-color: #eef; }
        .user { font-weight: bold; }
        .machine { color: gray; margin-left: 10px; }
        .line[contenteditable="true"] { background-color: #ffffcc; outline: 1px dashed #999; }
        .highlight { background-color: #d1ecf1 !important; }
        .record-btn { position: absolute; right: 10px; top: 8px; background: #2196f3; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .result { margin-top: 5px; font-size: 13px; }
        #toolbar { display: none; position: absolute; background: #fff; border: 1px solid #ccc; padding: 5px; z-index: 1000; }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
    </head>

<body>
    <div style="margin: 20px auto; max-width: 800px;">
        <label>üîó Video URL (YouTube or Dailymotion):
            <input id="videoUrlInput" style="width: 400px;" type="text" value="" />
        </label><br /><br />
        <label>üìù English Transcript: <textarea id="scriptEN" rows="6" style="width: 100%;"></textarea></label><br /><br />
        <label>üáªüá≥ Vietnamese Transcript: <textarea id="scriptVI" rows="6" style="width: 100%;"></textarea></label><br /><br />
        <br />
        <button onclick="loadVideoAndTranscript()">‚ñ∂Ô∏è Load Video + Transcript</button><br />
        <button onclick="saveScripts()">üíæ Save Script</button>
        <br /><br />
        <label>üìÇ Load Saved Script (.json):
            <input type="file" id="loadFileInput" accept=".json" onchange="loadScriptFile(event)">
        </label>
    </div>
    
    <div id="player-container">
        <div id="player"></div>
    </div>
    
    <h3>Transcript (EN + VI)</h3>
    <div id="toolbar">
        <button onclick="execCmd('bold')"><b>B</b></button>
        <button onclick="execCmd('italic')"><i>I</i></button>
        <button onclick="execCmd('underline')"><u>U</u></button>
        <input onchange="execCmd('foreColor', this.value)" type="color" />
    </div>
    <div id="transcript"></div>
    <button id="togglePause" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 10px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Pause</button>

    <script>
        let activePlayer; // S·∫Ω l√† YT.Player ho·∫∑c th·∫ª <iframe> c·ªßa Dailymotion
        let playerType = null;
        let transcriptData = [];
        let userScrolling = false;
        let scrollTimeout = null;
        let isPlayerReady = false;

        // Bi·∫øn tr·∫°ng th√°i cho Dailymotion (v√¨ API m·ªõi kh√¥ng cho truy c·∫≠p tr·ª±c ti·∫øp)
        let dmCurrentTime = 0;
        let dmIsPlaying = false;

        // --- B·ªò ƒêI·ªÄU KHI·ªÇN PLAYER TR·ª™U T∆Ø·ª¢NG (Player Wrapper) ---
        const playerWrapper = {
            seekTo: function(time) {
                if (!isPlayerReady) return;
                if (playerType === 'youtube') {
                    activePlayer.seekTo(time, true);
                } else if (playerType === 'dailymotion') {
                    activePlayer.contentWindow.postMessage('seek=' + time, '*');
                }
            },
            play: function() {
                if (!isPlayerReady) return;
                if (playerType === 'youtube') {
                    activePlayer.playVideo();
                } else if (playerType === 'dailymotion') {
                    activePlayer.contentWindow.postMessage('play', '*');
                }
            },
            pause: function() {
                if (!isPlayerReady) return;
                if (playerType === 'youtube') {
                    activePlayer.pauseVideo();
                } else if (playerType === 'dailymotion') {
                    activePlayer.contentWindow.postMessage('pause', '*');
                }
            },
            getCurrentTime: function() {
                // ƒê√£ chuy·ªÉn th√†nh h√†m ƒë·ªìng b·ªô, tr·∫£ v·ªÅ gi√° tr·ªã ƒë√£ l∆∞u
                if (playerType === 'youtube') {
                    return activePlayer.getCurrentTime ? activePlayer.getCurrentTime() : 0;
                } else if (playerType === 'dailymotion') {
                    return dmCurrentTime;
                }
                return 0;
            },
            isPlaying: function() {
                if (!isPlayerReady) return false;
                if (playerType === 'youtube') {
                    return activePlayer.getPlayerState() === YT.PlayerState.PLAYING;
                } else if (playerType === 'dailymotion') {
                    return dmIsPlaying;
                }
                return false;
            }
        };

        // --- L·∫ÆNG NGHE S·ª∞ KI·ªÜN T·ª™ IFRAME C·ª¶A DAILYMOTION ---
        window.addEventListener('message', (event) => {
            if (event.origin !== "https://www.dailymotion.com") {
                return;
            }
            // Parse d·ªØ li·ªáu t·ª´ Dailymotion
            const data = {};
            event.data.split('&').forEach(pair => {
                const parts = pair.split('=');
                data[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
            });

            if (data.event === 'apiready') {
                isPlayerReady = true;
            }
            if (data.event === 'play') {
                dmIsPlaying = true;
                onPlayerPlay();
            }
            if (data.event === 'pause' || data.event === 'end') {
                dmIsPlaying = false;
                onPlayerPause();
            }
            if (data.event === 'timeupdate') {
                dmCurrentTime = parseFloat(data.time);
            }
        });


        // --- C√ÅC H√ÄM X·ª¨ L√ù CHUNG ---
        function onPlayerPlay() {
            document.getElementById('togglePause').textContent = 'Pause';
            requestAnimationFrame(trackCurrentLine);
        }
        function onPlayerPause() {
            document.getElementById('togglePause').textContent = 'Play';
        }
        function onYouTubeIframeAPIReady() {} // Callback c·ªßa Youtube

        function trackCurrentLine() {
            if (!playerWrapper.isPlaying()) return;
            
            const currentTime = playerWrapper.getCurrentTime();
            let currentId = null;
            for (let i = 0; i < transcriptData.length; i++) {
                const line = transcriptData[i];
                if (currentTime >= line.time && (i === transcriptData.length - 1 || currentTime < transcriptData[i + 1].time)) {
                    currentId = line.id;
                    break;
                }
            }
            document.querySelectorAll('.line').forEach(el => el.classList.remove('highlight'));
            if (currentId && currentId.startsWith('en_')) {
                const activeEl = document.getElementById(currentId);
                if (activeEl) {
                    activeEl.classList.add('highlight');
                    if (!userScrolling) {
                        activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
            requestAnimationFrame(trackCurrentLine);
        }
        
        function parseVideoUrl(url) {
            let match = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (match) return { platform: 'youtube', videoId: match[1] };
            match = url.match(/(?:https?:\/\/)?(?:www\.)?(?:dailymotion\.com\/(?:video|embed\/video)\/|dai\.ly\/)([a-zA-Z0-9]+)/);
            if (match) return { platform: 'dailymotion', videoId: match[1] };
            return null;
        }

        function loadVideoAndTranscript() {
            const videoUrl = document.getElementById('videoUrlInput').value.trim();
            if (!videoUrl) {
                alert('Please enter a video URL.');
                return;
            }
            const videoInfo = parseVideoUrl(videoUrl);
            if (!videoInfo) {
                alert('Invalid YouTube or Dailymotion URL.');
                return;
            }

            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = ''; 
            if (activePlayer && playerType === 'youtube' && typeof activePlayer.destroy === 'function') {
                activePlayer.destroy();
            }
            activePlayer = null;
            isPlayerReady = false;
            // Reset tr·∫°ng th√°i Dailymotion
            dmCurrentTime = 0;
            dmIsPlaying = false;

            playerType = videoInfo.platform;

            if (playerType === 'youtube') {
                activePlayer = new YT.Player('player', {
                    height: '360',
                    width: '640',
                    videoId: videoInfo.videoId,
                    events: {
                        'onReady': () => { isPlayerReady = true; },
                        'onStateChange': (event) => {
                            if (event.data === YT.PlayerState.PLAYING) onPlayerPlay();
                            else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) onPlayerPause();
                        }
                    }
                });
            } else if (playerType === 'dailymotion') {
                // T·∫†O IFRAME THEO PH∆Ø∆†NG PH√ÅP M·ªöI
                const iframe = document.createElement('iframe');
                iframe.setAttribute('width', '640');
                iframe.setAttribute('height', '360');
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
                // URL ƒë·∫∑c bi·ªát ƒë·ªÉ k√≠ch ho·∫°t API postMessage
                iframe.setAttribute('src', `https://www.dailymotion.com/embed/video/${videoInfo.videoId}?api=postMessage`);
                
                playerDiv.appendChild(iframe);
                activePlayer = iframe; // L∆∞u th·∫ª iframe l√†m player
            }
            
            loadTranscriptContent();
        }

        function loadTranscriptContent() {
             const rawEN = document.getElementById('scriptEN').value.trim();
             const rawVI = document.getElementById('scriptVI').value.trim();
             const en = parseTranscript(rawEN);
             const vi = parseTranscript(rawVI);
             const transcript = document.getElementById('transcript');
             transcript.innerHTML = '';
             transcriptData = [];
             for (let i = 0; i < Math.max(en.length, vi.length); i++) {
                 if (en[i]) {
                     const text = `[${Math.floor(en[i].time / 60)}:${(en[i].time % 60).toString().padStart(2, '0')}] ${en[i].text}`;
                     const div = createLineCard('en_' + i, en[i].time, text, 'user');
                     transcript.appendChild(div);
                     transcriptData.push({ id: 'en_' + i, time: en[i].time });
                 }
                 if (vi[i]) {
                     const text = `[VI] ${vi[i].text}`;
                     const div = createLineCard('vi_' + i, vi[i].time, text, 'machine');
                     transcript.appendChild(div);
                 }
             }
        }
        
        // --- C√°c h√†m ti·ªán √≠ch (gi·ªØ nguy√™n, kh√¥ng c·∫ßn s·ª≠a) ---
        document.getElementById('togglePause').onclick = function() { if (playerWrapper.isPlaying()) { playerWrapper.pause(); } else { playerWrapper.play(); } };
        function parseTranscript(raw) { const lines = raw.trim().split('\n'); const parsed = []; let currentTime = null, currentText = []; for (const line of lines) { const match = line.match(/^(\d+):(\d{2})$/); if (match) { if (currentTime !== null && currentText.length) parsed.push({ time: currentTime, text: currentText.join('<br>') }); currentTime = parseInt(match[1]) * 60 + parseInt(match[2]); currentText = []; } else { currentText.push(line.trim()); } } if (currentTime !== null && currentText.length) parsed.push({ time: currentTime, text: currentText.join('<br>') }); return parsed; }
        function createLineCard(id, time, fallbackText, className) { const div = document.createElement('div'); div.className = `line ${className}`; div.dataset.time = time; div.id = id; div.innerHTML = fallbackText; div.onclick = () => playerWrapper.seekTo(time); if (className === 'user') { const btn = document.createElement('button'); btn.className = 'record-btn'; btn.textContent = 'üé§'; btn.onclick = (e) => { e.stopPropagation(); startSpeechRecognition(div, fallbackText); }; div.appendChild(btn); } return div; }
        document.getElementById('transcript').addEventListener('wheel', () => { userScrolling = true; clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => userScrolling = false, 9000); });
        document.addEventListener('dblclick', e => { if (e.target.classList.contains('line')) { e.target.contentEditable = true; e.target.focus(); } });
        document.addEventListener('mouseup', e => { const sel = window.getSelection(); if (sel.toString().length > 0) { const rect = sel.getRangeAt(0).getBoundingClientRect(); const toolbar = document.getElementById('toolbar'); toolbar.style.top = `${window.scrollY + rect.top - 40}px`; toolbar.style.left = `${window.scrollX + rect.left}px`; toolbar.style.display = 'block'; } else { document.getElementById('toolbar').style.display = 'none'; } });
        function execCmd(cmd, value = null) { document.execCommand(cmd, false, value); }
        function startSpeechRecognition(div, expectedText) { const oldResult = div.querySelector('.result'); if (oldResult) oldResult.remove(); const oldPlayback = div.querySelector('.playback-container'); if (oldPlayback) oldPlayback.remove(); if (!('webkitSpeechRecognition' in window) || !navigator.mediaDevices) { alert('Speech recognition or recording not supported in this browser'); return; } navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { const mediaRecorder = new MediaRecorder(stream); const audioChunks = []; mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); }; mediaRecorder.onstop = () => { const audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); const audioUrl = URL.createObjectURL(audioBlob); const playbackContainer = document.createElement('div'); playbackContainer.className = 'playback-container'; const listenButton = document.createElement('button'); listenButton.textContent = '‚ñ∂Ô∏è Listen Again'; listenButton.style.marginTop = '5px'; listenButton.onclick = () => new Audio(audioUrl).play(); playbackContainer.appendChild(listenButton); div.appendChild(playbackContainer); }; mediaRecorder.start(); const recognition = new webkitSpeechRecognition(); recognition.lang = 'ja-JP'; recognition.interimResults = false; recognition.maxAlternatives = 1; recognition.onend = () => { mediaRecorder.stop(); stream.getTracks().forEach(track => track.stop()); }; recognition.onresult = function(event) { const spokenText = event.results[0][0].transcript; const score = similarity(spokenText.toLowerCase(), expectedText.replace(/\[.*?\]/g, '').toLowerCase()); const resultEl = document.createElement('div'); resultEl.className = 'result'; resultEl.innerHTML = `You said: "<em>${spokenText}</em>" ‚Üí Similarity: <b>${Math.round(score * 100)}%</b>`; div.appendChild(resultEl); }; recognition.onerror = function(event) { alert('Error occurred in recognition: ' + event.error); mediaRecorder.stop(); }; recognition.start(); }).catch(err => { alert('Could not access the microphone. Please grant permission.'); console.error("Error accessing microphone:", err); }); }
        function similarity(s1, s2) { const longer = s1.length > s2.length ? s1 : s2; const shorter = s1.length > s2.length ? s2 : s1; const longerLength = longer.length; if (longerLength === 0) return 1.0; return (longerLength - editDistance(longer, shorter)) / longerLength; }
        function editDistance(s1, s2) { s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = []; for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i === 0) costs[j] = j; else if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length]; }
        function saveScripts() { const videoUrl = document.getElementById('videoUrlInput').value.trim(); const lines = document.querySelectorAll('.line'); const enChunks = []; const viChunks = []; for (const line of lines) { const time = parseInt(line.dataset.time || '0'); const minutes = Math.floor(time / 60); const seconds = (time % 60).toString().padStart(2, '0'); let content = line.innerHTML.replace(/<button[^>]*>.*?<\/button>/g, '').replace(/<div class="result">.*?<\/div>/g, '').replace(/<div class="playback-container">.*?<\/div>/g, '').replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').replace(/\n{2,}/g, '\n').trim(); let block; if (line.classList.contains('user')) { const cleanContent = content.replace(/^\[\d+:\d{2}\]\s*/, ''); block = `${minutes}:${seconds}\n${cleanContent}`; enChunks.push(block); } else if (line.classList.contains('machine')) { const cleanContent = content.replace(/^\[VI\]\s*/, ''); block = `${minutes}:${seconds}\n${cleanContent}`; viChunks.push(block); } } const blob = new Blob([JSON.stringify({ videoUrl, enText: enChunks.join('\n\n'), viText: viChunks.join('\n\n') }, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `transcript_${videoUrl.split('/').pop() || 'video'}.json`; a.click(); URL.revokeObjectURL(url); }
        function loadScriptFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); document.getElementById('videoUrlInput').value = data.videoUrl || data.videoId || ''; document.getElementById('scriptEN').value = data.enText || ''; document.getElementById('scriptVI').value = data.viText || ''; } catch (err) { alert('Invalid JSON file.'); } }; reader.readAsText(file); }
    </script>
</body>

</html>
