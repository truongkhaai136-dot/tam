<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dailymotion Bilingual Trainer ‚Äî Sync + Practice</title>
  <style>
    :root{
      --bg:#0f1216; --panel:#151a21; --soft:#1d2430; --accent:#3aa3ff; --accent-2:#69e0a5; --text:#e8eef5; --muted:#a8b3c2; --warn:#ffb020;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .app{display:grid;grid-template-rows:auto auto 1fr;gap:12px;max-width:1200px;margin:0 auto;padding:14px;}
    h1{font-size:clamp(18px,2.6vw,28px);margin:6px 0 2px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:6px}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;background:var(--panel);border:1px solid #202733;padding:10px;border-radius:14px;box-shadow:var(--shadow);align-items:center}
    .toolbar .group{display:flex;gap:8px;align-items:center}
    .toolbar input[type="text"], .toolbar textarea{background:#0b0f14;color:var(--text);border:1px solid #233041;border-radius:10px;padding:10px;}
    .toolbar input[type="text"]{width:240px}
    .toolbar textarea{width:360px;height:100px}
    .toolbar button, .pill{cursor:pointer;background:linear-gradient(180deg,#1e2733,#141a23);color:var(--text);border:1px solid #263346;border-radius:999px;padding:9px 12px;font-weight:600}
    .toolbar button:hover{border-color:#365069}
    .pill{font-size:12px;opacity:.9}

    .layout{display:grid;grid-template-columns: minmax(280px, 1fr) minmax(380px, 1.1fr); gap:14px}
    .panel{background:var(--panel);border:1px solid #202733;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid #202733;background:linear-gradient(180deg,#161c24,#121821);font-size:14px;color:var(--muted)}
    .player-wrap{position:relative;aspect-ratio:16/9;background:#0b0f14}
    #player{position:absolute;inset:0}

    .transcript{height:100%;display:flex;flex-direction:column}
    .transcript-controls{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #202733;background:#121821;position:sticky;top:0;z-index:5}
    .transcript-controls input[type="search"]{flex:1;min-width:120px;background:#0b0f14;border:1px solid #233041;border-radius:10px;color:var(--text);padding:8px 10px}
    .lines{overflow:auto;scroll-behavior:smooth;padding:8px}

    .line{display:grid;grid-template-columns:56px 1fr;gap:10px;padding:10px;border-radius:12px;border:1px solid transparent}
    .line:hover{background:rgba(255,255,255,0.03);border-color:#293241}
    .timestamp{font-variant-numeric:tabular-nums;color:var(--muted);cursor:pointer;user-select:none}
    .seg{display:flex;flex-direction:column;gap:6px}
    .en, .vi{line-height:1.5}
    .en{font-weight:600}
    .vi{color:#c8d2de}
    .active{background:linear-gradient(180deg, rgba(58,163,255,.10), rgba(58,163,255,.04)); border-color:#2c5080}
    .active .timestamp{color:var(--accent)}

    .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .icon-btn{cursor:pointer;display:inline-flex;align-items:center;gap:6px;border:1px solid #2b3a4e;background:#0d141d;border-radius:10px;padding:6px 10px;font-size:12px}
    .icon-btn[aria-pressed="true"]{border-color:var(--accent);background:rgba(58,163,255,.12)}

    /* floating format toolbar for selection editing */
    .formatbar{position:fixed;display:none;gap:6px;padding:6px;border:1px solid #2b3a4e;background:#0d141d;border-radius:10px;box-shadow:var(--shadow);z-index:9999}
    .formatbar button{background:#121a24;border:1px solid #2b3a4e;border-radius:8px;padding:6px 8px;color:var(--text);cursor:pointer}

    .score{font-size:12px;color:var(--accent-2);margin-left:6px}
    .error{color:#ff7a7a;font-size:12px}

    .footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;padding:6px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üé¨ Dailymotion Bilingual Trainer</h1>
      <div class="sub">T·∫£i video + l·ªùi tho·∫°i, hi·ªÉn th·ªã song ng·ªØ, ƒë·ªìng b·ªô theo th·ªùi gian, ch·ªânh s·ª≠a tr·ª±c ti·∫øp v√† luy·ªán ph√°t √¢m t·ª´ng d√≤ng.</div>
    </header>

    <section class="toolbar" id="loader">
      <div class="group">
        <label for="videoId" class="pill">Video ID</label>
        <input id="videoId" type="text" placeholder="vd: x8abcd" />
        <button id="btnLoad">T·∫£i video + L·ªùi tho·∫°i</button>
      </div>
      <div class="group">
        <div style="display:flex;flex-direction:column;gap:6px">
          <label class="pill">L·ªùi tho·∫°i üá¨üáß (m·ªói d√≤ng c√≥ th·ªùi gian)</label>
          <textarea id="enText" placeholder="0:37 Maybe it's to make you believe\n0:41 Everything you once doubted\n..."></textarea>
        </div>
      </div>
      <div class="group">
        <div style="display:flex;flex-direction:column;gap:6px">
          <label class="pill">L·ªùi tho·∫°i üáªüá≥ (m·ªói d√≤ng c√≥ th·ªùi gian)</label>
          <textarea id="viText" placeholder="0:37 C√≥ l·∫Ω l√† ƒë·ªÉ b·∫°n tin\n0:41 M·ªçi ƒëi·ªÅu b·∫°n t·ª´ng nghi ng·ªù\n..."></textarea>
        </div>
      </div>
      <div class="group">
        <button id="btnSave">üíæ L∆∞u phi√™n (.json)</button>
        <input id="fileOpen" type="file" accept="application/json" hidden />
        <button id="btnOpen">üìÇ M·ªü phi√™n</button>
      </div>
    </section>

    <section class="layout">
      <div class="panel">
        <h3>Video</h3>
        <div class="player-wrap"><div id="player"></div></div>
        <div class="footer" id="playerState">Tr·∫°ng th√°i: <span>Ch∆∞a t·∫£i</span></div>
      </div>

      <div class="panel transcript">
        <h3>L·ªùi tho·∫°i (nh·∫•p ƒë·ªÉ tua ‚Ä¢ nh·∫•p ƒë√∫p ƒë·ªÉ ch·ªânh s·ª≠a ‚Ä¢ üé§ ƒë·ªÉ luy·ªán ph√°t √¢m)</h3>
        <div class="transcript-controls">
          <input id="search" type="search" placeholder="T√¨m nhanh (EN/VI)" />
          <button id="btnResume" class="icon-btn hidden">üîÅ Ti·∫øp t·ª•c t·ª± cu·ªôn</button>
          <span class="pill">T·ª± cu·ªôn: <b id="autoStatus">ON</b></span>
        </div>
        <div id="lines" class="lines" tabindex="0" aria-label="Transcript lines"></div>
      </div>
    </section>

    <div class="formatbar" id="formatbar">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="foreColor" data-color="#ff5c5c">A</button>
      <button data-cmd="foreColor" data-color="#4bdc8b">A</button>
      <button data-cmd="foreColor" data-color="#3aa3ff">A</button>
    </div>

    <footer class="footer">Tip: ƒê·ªãnh d·∫°ng khi ƒëang ch·ªânh s·ª≠a (b√¥i ƒëen ‚Üí thanh c√¥ng c·ª• n·ªïi). Tua nhanh b·∫±ng c√°ch nh·∫•p m·ªëc th·ªùi gian ho·∫∑c d√≤ng b·∫•t k·ª≥.</footer>
  </div>

  <!-- Dailymotion SDK -->
  <script src="https://api.dmcdn.net/all.js"></script>
  <script>
  // ===== Utilities =====
  const $ = (s, p=document) => p.querySelector(s);
  const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
  const pad = n => String(Math.floor(n)).padStart(2,'0');
  const toClock = sec => {
    const s = Math.max(0, Math.floor(sec));
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), r = s%60;
    return h>0 ? `${h}:${pad(m)}:${pad(r)}` : `${m}:${pad(r)}`;
  }
  const parseTime = (str) => {
    // Accept: 0:37 | 00:37 | 1:02:03 | [00:37] | 37 (sec)
    const t = (str||'').trim();
    const b = t.replace(/[\[\]]/g,'').match(/^(?:(\d+):)?(\d{1,2}):(\d{2})$/);
    if (b) { const h = +(b[1]||0), m=+b[2], s=+b[3]; return h*3600+m*60+s; }
    const mmss = t.match(/^(\d{1,2}):(\d{2})/); if (mmss){ return (+mmss[1])*60 + (+mmss[2]); }
    const sec = t.match(/^(\d+)(?:\.\d+)?$/); if (sec) return +sec[1];
    // look for leading time then text
    const lead = t.match(/(?:(\d+):)?(\d{1,2}):(\d{2})/); if (lead){ const h=+(lead[1]||0), m=+lead[2], s=+lead[3]; return h*3600+m*60+s; }
    return null;
  }
  const splitLines = (txt) => (txt||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  function parseTranscript(raw){
    // Return array of {time, text}
    const out=[]; splitLines(raw).forEach(line=>{
      const m = line.match(/^\s*(?:\[(.*?)\]|([^\s]+))\s+(.*)$/);
      let t=null, text='';
      if(m){ t=parseTime(m[1]||m[2]); text=m[3]; }
      if(t===null){
        // try scan time anywhere
        const tm=line.match(/(?:(\d+):)?(\d{1,2}):(\d{2})/);
        if(tm){ t=parseTime(tm[0]); text=line.replace(tm[0],'').trim(); }
      }
      if(t!==null){ out.push({time:t, text:text}); }
    });
    return out.sort((a,b)=>a.time-b.time);
  }

  // ===== Global State =====
  let player=null; let apiReady=false; let currentTime=0; let autoScroll=true; let autoScrollTimer=null; let enSeg=[], viSeg=[];

  // ===== Player Setup =====
  function loadPlayer(videoId){
    $('#playerState span').textContent = 'ƒêang t·∫£i...';
    $('#player').innerHTML = '';
    player = DM.player(document.getElementById('player'), {
      video: videoId,
      params: { controls: 1, origin: location.origin }
    });
    player.addEventListener('apiready', ()=>{
      apiReady=true; $('#playerState span').textContent='S·∫µn s√†ng';
      player.addEventListener('timeupdate', (e)=>{ currentTime = e.time; highlightAt(currentTime); });
      player.addEventListener('play', ()=> setAutoScroll(true));
    });
    player.addEventListener('error', (e)=>{ $('#playerState span').textContent='L·ªói ph√°t video'; console.error(e); });
  }

  // ===== Render Transcript =====
  function mergeBilingual(en, vi){
    // Build a unified set of timestamps
    const mapEn = new Map(en.map(x=>[x.time,x.text]));
    const mapVi = new Map(vi.map(x=>[x.time,x.text]));
    const times = Array.from(new Set([...mapEn.keys(), ...mapVi.keys()])).sort((a,b)=>a-b);
    return times.map(t=>({ time:t, en: mapEn.get(t)||'', vi: mapVi.get(t)||'' }));
  }

  function renderLines(pairs){
    const box = $('#lines'); box.innerHTML='';
    pairs.forEach(row=>{
      const el = document.createElement('div'); el.className='line'; el.dataset.time=row.time;
      el.innerHTML = `
        <div class="timestamp" title="Nh·∫•p ƒë·ªÉ tua">${toClock(row.time)}</div>
        <div class="seg">
          <div class="en" contenteditable="false">${row.en || ''}</div>
          <div class="vi" contenteditable="false">${row.vi || ''}</div>
          <div class="controls-row">
            <button class="icon-btn btn-jump">‚è© T·ªõi m·ªëc n√†y</button>
            <button class="icon-btn btn-edit">‚úèÔ∏è S·ª≠a</button>
            <button class="icon-btn btn-rec" data-state="idle">üé§ Luy·ªán ph√°t √¢m</button>
            <span class="score"></span>
            <span class="error"></span>
          </div>
        </div>`;
      box.appendChild(el);
    });
  }

  // ===== Highlight + Auto Scroll =====
  function highlightAt(t){
    const lines=$$('#lines .line'); if(!lines.length) return;
    // find the last line with time <= t
    let target=null; for(const ln of lines){ const time=+ln.dataset.time; if(time<=t) target=ln; else break; }
    lines.forEach(l=>l.classList.remove('active'));
    if(target){ target.classList.add('active'); if(autoScroll) scrollIntoViewCentered(target); }
  }
  function scrollIntoViewCentered(el){
    const container = $('#lines'); const rect = el.getBoundingClientRect(); const crect = container.getBoundingClientRect();
    const offset = rect.top - crect.top - (crect.height/2 - rect.height/2);
    container.scrollBy({top: offset, behavior: 'smooth'});
  }
  function setAutoScroll(on){
    autoScroll = on; $('#autoStatus').textContent = on ? 'ON' : 'OFF';
    $('#btnResume').classList.toggle('hidden', on);
  }

  // Pause auto-scroll when user scrolls manually
  $('#lines').addEventListener('wheel', ()=>{ setAutoScroll(false); clearTimeout(autoScrollTimer); autoScrollTimer=setTimeout(()=>setAutoScroll(true), 6000); });
  $('#btnResume').addEventListener('click', ()=> setAutoScroll(true));

  // Click to seek
  $('#lines').addEventListener('click', (e)=>{
    const line = e.target.closest('.line'); if(!line) return;
    if(e.target.classList.contains('btn-jump') || e.target.classList.contains('timestamp') || e.target.classList.contains('en') || e.target.classList.contains('vi')){
      const t = +line.dataset.time; if(apiReady && player?.seek){ player.seek(t); player.play(); }
    }
  });

  // Edit on double-click
  $('#lines').addEventListener('dblclick', (e)=>{
    const en = e.target.closest('.line')?.querySelector('.en');
    const vi = e.target.closest('.line')?.querySelector('.vi');
    if(!en||!vi) return;
    en.contentEditable = 'true'; vi.contentEditable='true';
    en.focus();
  });

  // End editing when clicking outside a line
  document.addEventListener('click', (e)=>{
    const editing = $$('#lines .en[contenteditable="true"], #lines .vi[contenteditable="true"]').length>0;
    if(editing){
      const inLine = e.target.closest('.line');
      if(!inLine){ $$('#lines .en, #lines .vi').forEach(el=>el.contentEditable='false'); hideFormatbar(); }
    }
  });

  // Selection format toolbar
  const bar = $('#formatbar');
  function showFormatbar(){
    const sel = window.getSelection(); if(!sel.rangeCount) return;
    const rect = sel.getRangeAt(0).getBoundingClientRect();
    bar.style.left = Math.max(8, rect.left + rect.width/2 - bar.offsetWidth/2) + 'px';
    bar.style.top = Math.max(8, rect.top - 48) + 'px';
    bar.style.display='flex';
  }
  function hideFormatbar(){ bar.style.display='none'; }
  document.addEventListener('selectionchange', ()=>{
    const sel = window.getSelection();
    const target = sel.anchorNode && (sel.anchorNode.parentElement || sel.anchorNode);
    const inEditable = target && (target.closest?.('.en[contenteditable="true"], .vi[contenteditable="true"]'));
    if(sel && !sel.isCollapsed && inEditable){ showFormatbar(); } else { hideFormatbar(); }
  });
  bar.addEventListener('mousedown', (e)=> e.preventDefault()); // keep selection
  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const cmd = btn.dataset.cmd; const color = btn.dataset.color;
    if(cmd==='foreColor' && color) document.execCommand(cmd,false,color);
    else document.execCommand(cmd,false,null);
  });

  // Search filter
  $('#search').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase();
    $$('#lines .line').forEach(line=>{
      const text = line.innerText.toLowerCase();
      line.style.display = text.includes(q)?'grid':'none';
    });
  });

  // ===== Load content =====
  $('#btnLoad').addEventListener('click', ()=>{
    const id = $('#videoId').value.trim(); if(!id){ alert('Nh·∫≠p Dailymotion Video ID'); return; }
    enSeg = parseTranscript($('#enText').value);
    viSeg = parseTranscript($('#viText').value);
    const pairs = mergeBilingual(enSeg, viSeg);
    renderLines(pairs);
    loadPlayer(id);
    setTimeout(()=>highlightAt(0), 50);
  });

  // ===== Pronunciation Practice =====
  function normalizeText(s){
    return (s||'').toLowerCase().replace(/[^a-z\s']/g,'').replace(/\s+/g,' ').trim();
  }
  function levenshtein(a,b){
    const aa=a.split(' '), bb=b.split(' ');
    const m=aa.length, n=bb.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){
      const cost = aa[i-1]===bb[j-1]?0:1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
    const dist=dp[m][n]; const denom=Math.max(m,n)||1; return Math.max(0, 1 - dist/denom);
  }

  async function startPractice(btn){
    const line = btn.closest('.line'); const en = line.querySelector('.en').innerText.trim();
    const scoreEl = line.querySelector('.score'); const errEl=line.querySelector('.error');
    scoreEl.textContent=''; errEl.textContent='';

    // Prepare recording (MediaRecorder) and SpeechRecognition
    let mediaStream; let mediaRecorder; let chunks=[]; let recog; let finalText='';
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new MediaRecorder(mediaStream);
      mediaRecorder.ondataavailable = (e)=>{ if(e.data.size>0) chunks.push(e.data); };
    }catch(e){ errEl.textContent='Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c micro'; console.error(e); }

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ errEl.textContent='Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Nh·∫≠n d·∫°ng gi·ªçng n√≥i'; }
    if(SR){
      recog = new SR();
      recog.lang='en-US'; recog.interimResults=false; recog.maxAlternatives=1;
      recog.onresult = (e)=>{ finalText = (e.results[0][0].transcript||'').trim(); };
      recog.onerror = (e)=>{ errEl.textContent='L·ªói nh·∫≠n d·∫°ng: '+e.error; };
    }

    // Start
    if(mediaRecorder){ mediaRecorder.start(); }
    if(recog){ try{ recog.start(); }catch(_){} }
    btn.dataset.state='recording'; btn.textContent='‚èπÔ∏è D·ª´ng';

    // Wait until user clicks again to stop
    const stop = () => new Promise(res=>{
      const handler = ()=>{ btn.removeEventListener('click', handler); res(); };
      btn.addEventListener('click', handler, {once:true});
    });
    await stop();

    // Stop
    if(recog){ try{ recog.stop(); }catch(_){} }
    if(mediaRecorder){ mediaRecorder.stop(); }
    await new Promise(r=> setTimeout(r, 250));

    const blob = chunks.length? new Blob(chunks, {type:'audio/webm'}) : null;
    if(blob){
      // Make Listen Again button
      const audioUrl = URL.createObjectURL(blob);
      const listenBtn = document.createElement('button'); listenBtn.className='icon-btn'; listenBtn.textContent='‚ñ∂Ô∏è Listen Again';
      listenBtn.addEventListener('click', ()=>{ const a=new Audio(audioUrl); a.play(); });
      btn.after(listenBtn);
    }

    // Score similarity
    const s1 = normalizeText(en); const s2 = normalizeText(finalText);
    const sim = levenshtein(s1, s2); const percent = Math.round(sim * 100);
    scoreEl.textContent = isFinite(percent) ? `ƒêi·ªÉm t∆∞∆°ng ƒë·ªìng: ${percent}%` : '';

    btn.dataset.state='idle'; btn.textContent='üé§ Luy·ªán ph√°t √¢m';
    mediaStream?.getTracks().forEach(t=>t.stop());
  }

  $('#lines').addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-rec'); if(!btn) return;
    const state = btn.dataset.state||'idle';
    if(state==='idle') startPractice(btn);
  });

  // ===== Save / Open session =====
  function collectSession(){
    const id = $('#videoId').value.trim();
    const items = $$('#lines .line').map(line=>({
      time: +line.dataset.time,
      enHtml: line.querySelector('.en').innerHTML,
      viHtml: line.querySelector('.vi').innerHTML
    }));
    return {version:1, savedAt: new Date().toISOString(), videoId:id, items};
  }
  function downloadJSON(obj, name='session.json'){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  $('#btnSave').addEventListener('click', ()=>{
    const ses = collectSession(); downloadJSON(ses, `dailymotion_session_${Date.now()}.json`);
  });
  $('#btnOpen').addEventListener('click', ()=> $('#fileOpen').click());
  $('#fileOpen').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return; const txt = await file.text();
    try{
      const data = JSON.parse(txt);
      if(data.videoId) $('#videoId').value = data.videoId;
      if(Array.isArray(data.items)){
        renderLines(data.items.map(it=>({time:it.time, en:it.enHtml, vi:it.viHtml})));
      }
      if(data.videoId) loadPlayer(data.videoId);
      setTimeout(()=>highlightAt(0), 80);
    }catch(err){ alert('T·ªáp kh√¥ng h·ª£p l·ªá'); console.error(err); }
  });

  // Keyboard: press E to toggle edit on active line
  document.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='e'){
      const act = $('#lines .line.active'); if(!act) return; const en=act.querySelector('.en'); const vi=act.querySelector('.vi');
      en.contentEditable = en.contentEditable==='true' ? 'false':'true';
      vi.contentEditable = en.contentEditable; if(en.isContentEditable) en.focus();
    }
  });
  </script>
</body>
</html>
