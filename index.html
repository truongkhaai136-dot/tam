<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>Transcript (EN + VI) - Dailymotion</title>
<style>
    body { font-family: Arial, sans-serif; }
    #player { margin-bottom: 15px; }
    #transcript { max-width: 800px; margin: 0 auto; }
    .line { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; position: relative; }
    .line:hover { background-color: #eef; }
    .user { font-weight: bold; }
    .machine { color: gray; margin-left: 10px; }
    .line[contenteditable="true"] {
      background-color: #ffffcc;
      outline: 1px dashed #999;
    }
    .highlight {
      background-color: #d1ecf1 !important;
    }
    .record-btn {
      position: absolute;
      right: 10px;
      top: 8px;
      background: #2196f3;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .result {
      margin-top: 5px;
      font-size: 13px;
    }
    #toolbar {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      z-index: 1000;
    }
</style>
<script src="https://geo.dailymotion.com/libs/player/x1x1x1.js"></script>
</head>
<body>

<div style="margin: 20px auto; max-width: 800px;">
  <label>üîó Dailymotion Video ID: <input id="videoIdInput" style="width: 300px;" type="text" value=""/></label><br/><br/>
  <label>üìù English Transcript: <textarea id="scriptEN" rows="6" style="width: 100%;"></textarea></label><br/><br/>
  <label>üáªüá≥ Vietnamese Transcript: <textarea id="scriptVI" rows="6" style="width: 100%;"></textarea></label><br/><br/>
  <br/>
  <button onclick="loadVideoAndTranscript()">‚ñ∂Ô∏è Load Video + Transcript</button><br/>
  <button onclick="saveScripts()">üíæ Save Script</button>
  <br/><br/>
  <label>üìÇ Load Saved Script (.json):
    <input type="file" id="loadFileInput" accept=".json" onchange="loadScriptFile(event)">
  </label>
</div>

<div id="player"></div>
<h3>Transcript (EN + VI)</h3>
<div id="toolbar">
  <button onclick="execCmd('bold')"><b>B</b></button>
  <button onclick="execCmd('italic')"><i>I</i></button>
  <button onclick="execCmd('underline')"><u>U</u></button>
  <input onchange="execCmd('foreColor', this.value)" type="color"/>
</div>
<div id="transcript"></div>

<button id="togglePause" disabled style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 999;
  padding: 10px 15px;
  background-color: #f44336;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: not-allowed;
  opacity: 0.5;
  font-size: 14px;">Play</button>

<script>
  let player;
  let transcriptData = [];
  let userScrolling = false;
  let scrollTimeout = null;

  function toggleVideoPlayback() {
    if (player && typeof player.pause === 'function' && typeof player.play === 'function') {
      if (player.paused) {
        player.play();
      } else {
        player.pause();
      }
    } else {
      alert("Video ch∆∞a ƒë∆∞·ª£c t·∫£i ho·∫∑c ƒëang t·∫£i. Vui l√≤ng ƒë·ª£i m·ªôt l√°t.");
    }
  }

  function setupPlayer(videoId) {
    if (player) {
      player.destroy();
    }
    
    document.getElementById('player').innerHTML = '';
    const toggleButton = document.getElementById('togglePause');
    // V√¥ hi·ªáu h√≥a n√∫t trong khi t·∫£i video m·ªõi
    toggleButton.disabled = true;
    toggleButton.style.opacity = '0.5';
    toggleButton.style.cursor = 'not-allowed';

    dailymotion.createPlayer("player", {
      video: videoId,
      width: "640",
      height: "360",
      params: { autoplay: false }
    }).then(p => {
      console.log("Player created successfully!");
      player = p;

      // **S·ª¨A L·ªñI #1** - K√≠ch ho·∫°t v√† c·∫≠p nh·∫≠t n√∫t khi player ƒë√£ s·∫µn s√†ng
      toggleButton.disabled = false;
      toggleButton.style.opacity = '1';
      toggleButton.style.cursor = 'pointer';
      toggleButton.textContent = 'Play';
      toggleButton.onclick = toggleVideoPlayback;

      player.on('play', () => {
        toggleButton.textContent = 'Pause';
        trackCurrentLine();
      });
      
      player.on('pause', () => {
        toggleButton.textContent = 'Play';
      });
      
    }).catch(error => {
      console.error("Failed to create Dailymotion player:", error);
      player = null;
      alert("L·ªñI: Kh√¥ng th·ªÉ t·∫£i video. Vui l√≤ng ki·ªÉm tra l·∫°i ID video, k·∫øt n·ªëi m·∫°ng ho·∫∑c t·∫Øt c√°c tr√¨nh ch·∫∑n qu·∫£ng c√°o r·ªìi th·ª≠ l·∫°i.");
    });
  }

  // **S·ª¨A L·ªñI #2** - C·∫≠p nh·∫≠t ƒëi·ªÅu ki·ªán 'isTyping'
  document.addEventListener('keydown', (event) => {
    const activeElement = document.activeElement;
    // Ki·ªÉm tra n·∫øu ƒëang g√µ trong input, textarea HO·∫∂C m·ªôt ph·∫ßn t·ª≠ c√≥ th·ªÉ ch·ªânh s·ª≠a
    const isTyping = ['INPUT', 'TEXTAREA'].includes(activeElement.tagName) || activeElement.isContentEditable;

    if (event.code === 'Space' && !isTyping) {
      event.preventDefault();
      toggleVideoPlayback();
    }
  });
  
  function trackCurrentLine() {
    if (!player || player.paused) return;

    const currentTime = player.currentTime;
    let currentId = null;
    
    for (let i = 0; i < transcriptData.length; i++) {
      const line = transcriptData[i];
      if (currentTime >= line.time && (i === transcriptData.length - 1 || currentTime < transcriptData[i + 1].time)) {
        currentId = line.id;
        break;
      }
    }
    
    document.querySelectorAll('.line').forEach(el => el.classList.remove('highlight'));
    
    if (currentId && currentId.startsWith('en_')) {
      const activeEl = document.getElementById(currentId);
      if (activeEl) {
        activeEl.classList.add('highlight');
        if (!userScrolling) {
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
    
    requestAnimationFrame(trackCurrentLine);
  }

  function parseTranscript(raw) {
    const lines = raw.trim().split('\n');
    const parsed = [];
    let currentTime = null, currentText = [];
    for (const line of lines) {
      const match = line.match(/^(\d+):(\d{2})$/);
      if (match) {
        if (currentTime !== null && currentText.length)
          parsed.push({ time: currentTime, text: currentText.join('<br>') });
        currentTime = parseInt(match[1]) * 60 + parseInt(match[2]);
        currentText = [];
      } else {
        currentText.push(line.trim());
      }
    }
    if (currentTime !== null && currentText.length)
      parsed.push({ time: currentTime, text: currentText.join('<br>') });
    return parsed;
  }

  function createLineCard(id, time, fallbackText, className) {
    const div = document.createElement('div');
    div.className = `line ${className}`;
    div.dataset.time = time;
    div.id = id;
    div.innerHTML = fallbackText;
    div.onclick = () => { if (player?.seek) player.seek(time); };

    if (className === 'user') {
      const btn = document.createElement('button');
      btn.className = 'record-btn';
      btn.textContent = 'üé§';
      btn.onclick = (e) => {
        e.stopPropagation();
      };
      div.appendChild(btn);
    }
    return div;
  }

  function loadVideoAndTranscript() {
    const videoId = document.getElementById('videoIdInput').value.trim();
    if (!videoId) {
      alert("Vui l√≤ng nh·∫≠p ID video Dailymotion.");
      return;
    }
    const rawEN = document.getElementById('scriptEN').value.trim();
    const rawVI = document.getElementById('scriptVI').value.trim();

    setupPlayer(videoId);

    const en = parseTranscript(rawEN);
    const vi = parseTranscript(rawVI);
    const transcript = document.getElementById('transcript');
    transcript.innerHTML = '';
    transcriptData = [];

    for (let i = 0; i < Math.max(en.length, vi.length); i++) {
      if (en[i]) {
        const text = `[${Math.floor(en[i].time / 60)}:${(en[i].time % 60).toString().padStart(2, '0')}] ${en[i].text}`;
        const div = createLineCard('en_' + i, en[i].time, text, 'user');
        transcript.appendChild(div);
        transcriptData.push({ id: 'en_' + i, time: en[i].time });
      }
      if (vi[i]) {
        const text = `[VI] ${vi[i].text}`;
        const div = createLineCard('vi_' + i, vi[i].time, text, 'machine');
        transcript.appendChild(div);
      }
    }
  }

  document.getElementById('transcript').addEventListener('wheel', () => {
    userScrolling = true;
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => userScrolling = false, 9000);
  });

  document.addEventListener('dblclick', e => {
    if (e.target.classList.contains('line')) {
      e.target.contentEditable = true;
      e.target.focus();
    }
  });

  document.addEventListener('mouseup', e => {
    const sel = window.getSelection();
    if (sel && sel.toString().length > 0) {
      const rect = sel.getRangeAt(0).getBoundingClientRect();
      const toolbar = document.getElementById('toolbar');
      toolbar.style.top = `${window.scrollY + rect.top - 40}px`; 
      toolbar.style.left = `${window.scrollX + rect.left}px`; 
      toolbar.style.display = 'block';
    } else {
      document.getElementById('toolbar').style.display = 'none';
    }
  });

  function execCmd(cmd, value = null) {
    document.execCommand(cmd, false, value);
  }

  function saveScripts() {
    alert("Ch·ª©c nƒÉng Save Script c·∫ßn ƒë∆∞·ª£c c√†i ƒë·∫∑t!");
  }
  function loadScriptFile(event) {
     alert("Ch·ª©c nƒÉng Load Script File c·∫ßn ƒë∆∞·ª£c c√†i ƒë·∫∑t!");
  }

</script>
</body>
</html>
