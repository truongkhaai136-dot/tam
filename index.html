<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đồng bộ script với video (Highlight như YouTube)</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b0f14; color:#e8eef7; }
    .wrap { display:grid; grid-template-columns:1fr 1.2fr 1fr; gap:12px; padding:12px; }
    .card { background:#10151c; border:1px solid #1b2637; border-radius:12px; display:flex; flex-direction:column; }
    .card header { background:#0f141b; padding:8px 12px; border-bottom:1px solid #1b2637; font-weight:bold; }
    .card .content { padding:10px; flex:1; overflow:auto; }
    #playerMount { aspect-ratio:16/9; background:#000; width:100%; }
    textarea { width:100%; height:200px; background:#0d131a; color:#e8eef7; border:1px solid #1b2637; border-radius:8px; padding:8px; }
    .btn { padding:6px 10px; border-radius:8px; border:1px solid #1b2637; background:#0d131a; color:#e8eef7; cursor:pointer; }
    .btn.primary { background:#4cc9f0; color:#00121a; border:none; }
    .line { display:grid; grid-template-columns:60px 1fr; gap:8px; padding:6px; border-radius:8px; cursor:pointer; }
    .line.active { background:#fff3b0; color:#1b2432; }
    .time { color:#a8b1c0; font-variant-numeric: tabular-nums; }
    .ja { font-size:15px; }
    .vi { font-size:13px; color:#cdd7e3; }
    @media(max-width:1000px){ .wrap{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <header>Script (gốc)</header>
      <div class="content">
        <textarea id="scriptInput" placeholder="00:02
こんな所で生活できたら どんなに幸せだろう そう思った

00:07
確かにそう思ったけど..."></textarea>
        <textarea id="transInput" placeholder="(Tuỳ chọn) Bản dịch tiếng Việt, mỗi đoạn 1 dòng ứng với script"></textarea>
        <button id="applyBtn" class="btn primary">Áp dụng script</button>
      </div>
    </section>
    <section class="card">
      <header>Video</header>
      <div class="content">
        <div id="playerMount"></div>
        <div style="margin-top:8px;">
          Video ID: <input id="videoId" type="text" value="x84sh87" style="width:120px;">
          <button id="loadVideo" class="btn">Tải</button>
          <button id="playPause" class="btn">Play/Pause</button>
        </div>
      </div>
    </section>
    <section class="card">
      <header>Phụ đề (highlight tự động)</header>
      <div class="content" id="lines"></div>
    </section>
  </div>

  <script src="https://geo.dailymotion.com/player.js"></script>
  <script>
    const el = {
      scriptInput: document.getElementById('scriptInput'),
      transInput: document.getElementById('transInput'),
      applyBtn: document.getElementById('applyBtn'),
      lines: document.getElementById('lines'),
      videoId: document.getElementById('videoId'),
      loadVideo: document.getElementById('loadVideo'),
      playPause: document.getElementById('playPause')
    };
    let player, entries=[], activeIndex=-1;

    function parseTime(str){
      if(!str) return null;
      const m3=str.match(/^(\d+):(\d{2}):(\d{2})$/);
      if(m3) return (+m3[1])*3600+(+m3[2])*60+(+m3[3]);
      const m2=str.match(/^(\d{1,2}):(\d{2})$/);
      if(m2) return (+m2[1])*60+(+m2[2]);
      return null;
    }
    function parseScript(raw){
      const lines=raw.replace(/\r\n?/g,'\n').split('\n');
      const blocks=[];
      for(let i=0;i<lines.length;i++){
        const line=lines[i].trim(); if(!line) continue;
        const m=line.match(/^((\d+:)?\d{1,2}:\d{2})(?:\s+(.+))?$/);
        if(m){ const t=parseTime(m[1]); if(t!=null){ blocks.push({start:t,ja:m[3]||''}); } continue; }
        if(parseTime(line)!=null){ const t=parseTime(line); let j=i+1,txt=[]; while(j<lines.length && parseTime(lines[j].trim())==null){ if(lines[j].trim()) txt.push(lines[j].trim()); j++; } blocks.push({start:t,ja:txt.join(' ')}); i=j-1; }
        else if(blocks.length){ blocks[blocks.length-1].ja += (blocks[blocks.length-1].ja?' ':'')+line; }
      }
      blocks.sort((a,b)=>a.start-b.start);
      for(let k=0;k<blocks.length;k++){ blocks[k].end=(blocks[k+1]?blocks[k+1].start:1e9); blocks[k].tStr=new Date(blocks[k].start*1000).toISOString().substr(14,5); }
      return blocks;
    }
    function renderEntries(){
      el.lines.innerHTML='';
      entries.forEach((e,i)=>{
        const row=document.createElement('div'); row.className='line'; row.dataset.index=i;
        row.innerHTML='<div class="time">'+e.tStr+'</div><div><div class="ja">'+e.ja+'</div>'+(e.vi?'<div class="vi">'+e.vi+'</div>':'')+'</div>';
        row.onclick=()=>{ if(player) player.seek(e.start); };
        el.lines.appendChild(row);
      });
    }
    function setActive(i){ if(i===activeIndex) return; if(activeIndex>=0){ const old=el.lines.querySelector('.line[data-index="'+activeIndex+'"]'); if(old) old.classList.remove('active'); } activeIndex=i; if(i>=0){ const cur=el.lines.querySelector('.line[data-index="'+i+'"]'); if(cur){ cur.classList.add('active'); cur.scrollIntoView({behavior:'smooth',block:'center'}); } } }
    function onTimeUpdate(sec){ for(let i=0;i<entries.length;i++){ if(sec>=entries[i].start && sec<entries[i].end){ setActive(i); return; } } }

    el.applyBtn.onclick=()=>{ const blocks=parseScript(el.scriptInput.value); const trans=el.transInput.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); entries=blocks.map((b,i)=>({...b,vi:trans[i]||''})); renderEntries(); activeIndex=-1; };
    el.loadVideo.onclick=()=>{ const xid=el.videoId.value.trim(); if(player) player.load({video:xid}); else{ player=DM.player(document.getElementById('playerMount'),{video:xid,width:'100%',height:'100%'}); player.addEventListener('timeupdate',e=>{onTimeUpdate(e.time);}); } };
    el.playPause.onclick=()=>{ if(!player) return; player.togglePlay(); };
    // init default video
    el.loadVideo.click();
  </script>
</body>
</html>
