<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• H·ªçc Ti·∫øng Anh qua Video</title>
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --card-bg: #0f3460;
            --text-color: #e94560;
            --light-text: #dcdcdc;
            --highlight-color: rgba(233, 69, 96, 0.2);
            --border-color: #e94560;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--light-text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls > div {
            flex: 1;
            min-width: 250px;
        }

        .controls label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .controls input[type="text"],
        .controls textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--secondary-bg);
            color: var(--light-text);
            box-sizing: border-box;
        }

        .controls textarea {
            height: 150px;
            resize: vertical;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        button, input[type="file"]::file-selector-button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--text-color);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover, input[type="file"]::file-selector-button:hover {
            background-color: #c73850;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        .video-container {
            flex: 1;
            min-width: 400px;
        }
        #player {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background-color: black;
            border-radius: 8px;
        }

        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--secondary-bg);
            scroll-behavior: smooth;
        }

        .line-pair {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .line-pair.highlight {
            background-color: var(--highlight-color);
        }
        
        .line-pair.highlight .en-line {
            font-weight: bold;
            color: var(--text-color);
        }

        .line {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }

        .line:focus {
            outline: 1px solid var(--text-color);
        }

        .en-line {
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vi-line {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
            font-style: italic;
        }

        .pronunciation-controls {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .mic-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            color: var(--light-text);
        }
        .mic-btn.recording {
            color: red;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .score {
            font-size: 0.8em;
            font-weight: bold;
        }
        .listen-again-btn {
            font-size: 0.8em;
            padding: 2px 6px;
            background-color: #0f3460;
            border: 1px solid var(--text-color);
        }

        #format-toolbar {
            position: absolute;
            display: none;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px;
            z-index: 1000;
        }

        #format-toolbar button {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 16px;
            padding: 5px;
            min-width: 30px;
        }
        #format-toolbar input[type="color"] {
            border: none;
            background: none;
            width: 25px;
            height: 25px;
            padding: 0;
        }

    </style>
</head>
<body>

    <h1>C√¥ng c·ª• H·ªçc Ti·∫øng Anh qua Video</h1>

    <div class="controls">
        <div>
            <label for="videoId">Dailymotion Video ID</label>
            <input type="text" id="videoId" placeholder="V√≠ d·ª•: x7z5x9z">
        </div>
        <div>
            <label for="enSubtitles">English Subtitles</label>
            <textarea id="enSubtitles" placeholder="D√°n l·ªùi tho·∫°i ti·∫øng Anh v√†o ƒë√¢y. ƒê·ªãnh d·∫°ng: [mm:ss.mss] text..."></textarea>
        </div>
        <div>
            <label for="viSubtitles">Vietnamese Subtitles</label>
            <textarea id="viSubtitles" placeholder="D√°n l·ªùi tho·∫°i ti·∫øng Vi·ªát v√†o ƒë√¢y. ƒê·ªãnh d·∫°ng: [mm:ss.mss] text..."></textarea>
        </div>
    </div>

    <div class="action-buttons">
        <button id="loadBtn">T·∫£i Video v√† L·ªùi tho·∫°i</button>
        <button id="saveBtn">L∆∞u phi√™n l√†m vi·ªác (.json)</button>
        <label for="loadFile" style="margin: 0;">
            <button onclick="document.getElementById('loadFile').click();" style="pointer-events: none;">M·ªü phi√™n l√†m vi·ªác</button>
        </label>
        <input type="file" id="loadFile" accept=".json" style="display: none;">
    </div>
    
    <div id="format-toolbar">
        <button data-command="bold"><b>B</b></button>
        <button data-command="italic"><i>I</i></button>
        <button data-command="underline"><u>U</u></button>
        <input type="color" data-command="foreColor" title="Ch·ªçn m√†u ch·ªØ">
    </div>

    <div class="main-content">
        <div class="video-container">
            <div id="player"></div>
        </div>
        <div class="lyrics-container" id="lyrics-container">
            <p>Vui l√≤ng nh·∫≠p ID video v√† l·ªùi tho·∫°i, sau ƒë√≥ nh·∫•n n√∫t t·∫£i.</p>
        </div>
    </div>

    <script src="https://api.dmcdn.net/all.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const videoIdInput = document.getElementById('videoId');
            const enSubtitlesInput = document.getElementById('enSubtitles');
            const viSubtitlesInput = document.getElementById('viSubtitles');
            const loadBtn = document.getElementById('loadBtn');
            const saveBtn = document.getElementById('saveBtn');
            const loadFileInput = document.getElementById('loadFile');
            const lyricsContainer = document.getElementById('lyrics-container');
            const playerElement = document.getElementById('player');
            const formatToolbar = document.getElementById('format-toolbar');

            let player;
            let subtitles = [];
            let currentHighlightIndex = -1;
            let userHasScrolled = false;

            // --- 1. T·∫£i v√† Hi·ªÉn th·ªã ƒê·ªìng b·ªô ---

            const parseTime = (timeStr) => {
                const parts = timeStr.match(/(\d{2}):(\d{2})\.(\d+)/);
                if (!parts) return 0;
                const minutes = parseInt(parts[1], 10);
                const seconds = parseInt(parts[2], 10);
                const milliseconds = parseInt(parts[3], 10);
                return minutes * 60 + seconds + milliseconds / 1000;
            };

            const parseSubtitles = (text) => {
                const lines = text.trim().split('\n');
                const regex = /\[(\d{2}:\d{2}\.\d+)\](.*)/;
                return lines.map(line => {
                    const match = line.match(regex);
                    if (match) {
                        return { time: parseTime(match[1]), text: match[2].trim() };
                    }
                    return null;
                }).filter(Boolean);
            };

            const loadContent = () => {
                const videoId = videoIdInput.value.trim();
                if (!videoId) {
                    alert('Vui l√≤ng nh·∫≠p Dailymotion Video ID.');
                    return;
                }

                const enSubs = parseSubtitles(enSubtitlesInput.value);
                const viSubs = parseSubtitles(viSubtitlesInput.value);

                // K·∫øt h·ª£p 2 ph·ª• ƒë·ªÅ
                subtitles = enSubs.map((enLine, index) => ({
                    time: enLine.time,
                    en: enLine.text,
                    vi: viSubs[index] ? viSubs[index].text : ''
                }));

                displaySubtitles();
                initDailymotionPlayer(videoId);
            };

            const displaySubtitles = () => {
                lyricsContainer.innerHTML = '';
                subtitles.forEach((line, index) => {
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'line-pair';
                    pairDiv.dataset.index = index;
                    pairDiv.dataset.time = line.time;

                    const enDiv = document.createElement('div');
                    enDiv.className = 'line en-line';
                    enDiv.innerHTML = `
                        <div class="pronunciation-controls">
                            <button class="mic-btn" title="Ghi √¢m v√† ch·∫•m ƒëi·ªÉm ph√°t √¢m">üé§</button>
                            <span class="score"></span>
                        </div>
                        <span class="text-content">${line.en}</span>
                    `;

                    const viDiv = document.createElement('div');
                    viDiv.className = 'line vi-line';
                    viDiv.innerHTML = `<span class="text-content">${line.vi}</span>`;

                    pairDiv.appendChild(enDiv);
                    pairDiv.appendChild(viDiv);
                    lyricsContainer.appendChild(pairDiv);
                });
            };
            
            const initDailymotionPlayer = (videoId) => {
                if(player) {
                    player.load(videoId);
                } else {
                    player = DM.player(playerElement, {
                        video: videoId,
                        width: '100%',
                        height: '100%',
                        params: { autoplay: false, controls: true }
                    });
                    player.addEventListener('timeupdate', onTimeUpdate);
                }
            };
            
            const onTimeUpdate = () => {
                if (!player || !subtitles.length) return;
                const currentTime = player.currentTime;
                let newHighlightIndex = -1;

                for (let i = subtitles.length - 1; i >= 0; i--) {
                    if (currentTime >= subtitles[i].time) {
                        newHighlightIndex = i;
                        break;
                    }
                }

                if (newHighlightIndex !== currentHighlightIndex) {
                    const oldLine = lyricsContainer.querySelector(`[data-index="${currentHighlightIndex}"]`);
                    if (oldLine) oldLine.classList.remove('highlight');
                    
                    const newLine = lyricsContainer.querySelector(`[data-index="${newHighlightIndex}"]`);
                    if (newLine) {
                        newLine.classList.add('highlight');
                        if (!userHasScrolled) {
                             newLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                    currentHighlightIndex = newHighlightIndex;
                }
            };

            lyricsContainer.addEventListener('scroll', () => {
                // Heuristic: if scroll is not triggered by our code, user has scrolled.
                // A better check would be to see if scroll is near top/bottom of element.
                // For simplicity, we use a timeout. If user scrolls, disable auto-scroll for a while.
                userHasScrolled = true;
                setTimeout(() => { userHasScrolled = false; }, 5000); // Re-enable after 5s of inactivity
            });

            // --- 2. T∆∞∆°ng t√°c v·ªõi Video v√† L·ªùi tho·∫°i ---
            
            lyricsContainer.addEventListener('click', (e) => {
                const linePair = e.target.closest('.line-pair');
                if (linePair && player) {
                    const time = parseFloat(linePair.dataset.time);
                    if (!isNaN(time)) {
                        player.seek(time);
                        userHasScrolled = false; // Re-enable auto-scroll on click
                    }
                }
            });

            lyricsContainer.addEventListener('dblclick', (e) => {
                const textContent = e.target.closest('.text-content');
                if (textContent) {
                    textContent.contentEditable = true;
                    textContent.focus();
                }
            });
            
            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const selectedElement = range.commonAncestorContainer.parentElement;
                    
                    if (selectedElement.isContentEditable) {
                        const rect = range.getBoundingClientRect();
                        formatToolbar.style.display = 'block';
                        formatToolbar.style.left = `${rect.left + window.scrollX}px`;
                        formatToolbar.style.top = `${rect.top + window.scrollY - formatToolbar.offsetHeight - 5}px`;
                        return;
                    }
                }
                formatToolbar.style.display = 'none';
            });

            formatToolbar.addEventListener('click', (e) => {
                const button = e.target.closest('button, input');
                if (button) {
                    const command = button.dataset.command;
                    const value = button.type === 'color' ? button.value : null;
                    document.execCommand(command, false, value);
                }
            });
             formatToolbar.addEventListener('change', (e) => {
                if (e.target.type === 'color') {
                    document.execCommand('foreColor', false, e.target.value);
                }
            });


            // --- 3. Luy·ªán ph√°t √¢m ---

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            let mediaRecorder;
            let audioChunks = [];

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                console.warn("Speech Recognition API kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát n√†y.");
            }

            const calculateSimilarity = (original, recognized) => {
                const originalWords = original.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(Boolean);
                const recognizedWords = recognized.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(Boolean);
                
                if (originalWords.length === 0) return recognizedWords.length === 0 ? 100 : 0;
                
                let matches = 0;
                const recognizedSet = new Set(recognizedWords);
                
                originalWords.forEach(word => {
                    if (recognizedSet.has(word)) {
                        matches++;
                        recognizedSet.delete(word); // Prevent matching the same word multiple times
                    }
                });
                return (matches / originalWords.length) * 100;
            };

            lyricsContainer.addEventListener('click', async (e) => {
                const micBtn = e.target.closest('.mic-btn');
                if (!micBtn || !SpeechRecognition) return;
                
                e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click tua video
                
                if (micBtn.classList.contains('recording')) {
                    recognition.stop();
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                    micBtn.classList.remove('recording');
                    micBtn.textContent = 'üé§';
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micBtn.classList.add('recording');
                    micBtn.textContent = 'üõë';

                    // Setup MediaRecorder for playback
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const parent = micBtn.parentElement;

                        let listenBtn = parent.querySelector('.listen-again-btn');
                        if (!listenBtn) {
                            listenBtn = document.createElement('button');
                            listenBtn.className = 'listen-again-btn';
                            listenBtn.textContent = 'Nghe l·∫°i';
                            parent.appendChild(listenBtn);
                        }
                        listenBtn.onclick = (event) => {
                            event.stopPropagation();
                            new Audio(audioUrl).play();
                        };
                        stream.getTracks().forEach(track => track.stop()); // T·∫Øt micro
                    };
                    
                    mediaRecorder.start();
                    
                    // Setup SpeechRecognition
                    const originalText = micBtn.closest('.en-line').querySelector('.text-content').textContent;
                    const scoreSpan = micBtn.parentElement.querySelector('.score');
                    scoreSpan.textContent = 'ƒêang nghe...';

                    recognition.onresult = (event) => {
                        const recognizedText = event.results[0][0].transcript;
                        const score = calculateSimilarity(originalText, recognizedText);
                        scoreSpan.textContent = `${score.toFixed(0)}%`;
                        scoreSpan.title = `B·∫°n n√≥i: "${recognizedText}"`;
                    };

                    recognition.onerror = (event) => {
                        console.error('L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i:', event.error);
                        scoreSpan.textContent = `L·ªói: ${event.error}`;
                    };

                    recognition.onend = () => {
                        micBtn.classList.remove('recording');
                        micBtn.textContent = 'üé§';
                         if (mediaRecorder && mediaRecorder.state === "recording") {
                            mediaRecorder.stop();
                        }
                    };
                    
                    recognition.start();

                } catch (err) {
                    console.error("Kh√¥ng th·ªÉ truy c·∫≠p micro:", err);
                    alert("Kh√¥ng th·ªÉ truy c·∫≠p micro. Vui l√≤ng c·∫•p quy·ªÅn cho trang web.");
                }
            });


            // --- 4. L∆∞u v√† M·ªü l·∫°i phi√™n l√†m vi·ªác ---

            const saveSession = () => {
                if (subtitles.length === 0) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u.');
                    return;
                }
                // L·∫•y n·ªôi dung ƒë√£ ch·ªânh s·ª≠a
                const currentSubData = Array.from(lyricsContainer.querySelectorAll('.line-pair')).map(pair => ({
                    time: parseFloat(pair.dataset.time),
                    en: pair.querySelector('.en-line .text-content').innerHTML,
                    vi: pair.querySelector('.vi-line .text-content').innerHTML,
                }));

                const sessionData = {
                    videoId: videoIdInput.value,
                    subtitles: currentSubData
                };

                const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session_${videoIdInput.value || 'data'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const loadSession = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        videoIdInput.value = data.videoId;
                        
                        // Clear textareas
                        enSubtitlesInput.value = '';
                        viSubtitlesInput.value = '';

                        subtitles = data.subtitles;
                        
                        displaySubtitles();
                        initDailymotionPlayer(data.videoId);

                    } catch (error) {
                        alert('T·ªáp JSON kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã l·ªói.');
                        console.error('L·ªói khi ƒë·ªçc t·ªáp JSON:', error);
                    }
                };
                reader.readAsText(file);
            };

            // G√°n s·ª± ki·ªán
            loadBtn.addEventListener('click', loadContent);
            saveBtn.addEventListener('click', saveSession);
            loadFileInput.addEventListener('change', loadSession);
        });
    </script>

</body>
</html>
