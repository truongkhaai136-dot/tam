<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• H·ªçc Ti·∫øng Anh qua Video</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f5f5;
            --text-color: #333;
            --highlight-bg: #e8f0fe;
            --border-color: #ddd;
            --button-hover: #357abd;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 15px;
            gap: 15px;
        }

        header {
            background-color: white;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }
        
        .controls button, .controls label {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            margin-left: 10px;
        }

        .controls button:hover, .controls label:hover {
            background-color: var(--button-hover);
        }

        .main-content {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .input-group textarea {
            height: 150px;
            resize: vertical;
        }

        #player-container {
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }
        
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #transcript-container {
            flex-grow: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px;
            overflow-y: scroll;
            scroll-behavior: smooth;
        }

        .transcript-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: background-color 0.3s, border-left-color 0.3s;
            border-radius: 0 5px 5px 0;
        }

        .transcript-item:hover {
            background-color: #f0f0f0;
        }

        .transcript-item.current {
            background-color: var(--highlight-bg);
            border-left-color: var(--primary-color);
            font-weight: bold;
        }

        .transcript-item p {
            margin: 0 0 5px 0;
            position: relative;
        }
        
        .transcript-item .lang-en {
            color: var(--text-color);
            font-size: 1.1em;
        }

        .transcript-item .lang-vi {
            color: #555;
            font-size: 0.95em;
        }
        
        .transcript-item small {
            color: #888;
            font-size: 0.8em;
            display: none; /* Hide timestamp in line by default */
        }
        
        [contenteditable="true"] {
            outline: 2px solid var(--primary-color);
            background-color: #fff;
            padding: 2px;
        }

        #format-toolbar {
            position: absolute;
            background-color: #333;
            color: white;
            border-radius: 5px;
            padding: 5px;
            display: none;
            z-index: 1000;
        }
        
        #format-toolbar button {
            background: none;
            border: none;
            color: white;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 1em;
        }

        #format-toolbar button:hover {
            background-color: #555;
        }
        
        #format-toolbar input[type="color"] {
            border: none;
            padding: 0;
            width: 25px;
            height: 25px;
            background: none;
            vertical-align: middle;
        }
        
        .pronunciation-tool {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            font-size: 0.9em;
        }
        
        .record-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            vertical-align: middle;
            color: #555;
            transition: color 0.2s;
        }

        .record-btn:hover {
            color: var(--primary-color);
        }
        
        .record-btn.recording {
            color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .score {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
        }
        
        .listen-again-btn {
            background: #eee;
            border: 1px solid #ccc;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <header>
        <h1>Luy·ªán Ph√°t √Çm v·ªõi Video</h1>
        <div class="controls">
            <button id="saveButton">L∆∞u phi√™n l√†m vi·ªác</button>
            <label for="loadFile">M·ªü phi√™n l√†m vi·ªác</label>
            <input type="file" id="loadFile" accept=".json" style="display: none;">
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h2>Thi·∫øt l·∫≠p</h2>
            <div class="input-group">
                <label for="videoId">ID Video Dailymotion</label>
                <input type="text" id="videoId" placeholder="V√≠ d·ª•: x8n5g5u">
            </div>
            <div class="input-group">
                <label for="enTranscript">L·ªùi tho·∫°i Ti·∫øng Anh (k√®m th·ªùi gian)</label>
                <textarea id="enTranscript" placeholder="D√°n l·ªùi tho·∫°i ti·∫øng Anh t·∫°i ƒë√¢y..."></textarea>
            </div>
            <div class="input-group">
                <label for="viTranscript">L·ªùi tho·∫°i Ti·∫øng Vi·ªát (k√®m th·ªùi gian)</label>
                <textarea id="viTranscript" placeholder="D√°n l·ªùi tho·∫°i ti·∫øng Vi·ªát t·∫°i ƒë√¢y..."></textarea>
            </div>
            <button id="loadData" style="width: 100%; padding: 12px; font-size: 1.1em; background-color: var(--success-color);">T·∫£i Video v√† L·ªùi tho·∫°i</button>
        </aside>

        <main class="main-content">
            <div id="player-container">
                <div id="player"></div>
            </div>
            <div id="transcript-container">
                 <p style="text-align: center; color: #888;">N·ªôi dung l·ªùi tho·∫°i s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi t·∫£i.</p>
            </div>
        </main>
    </div>
    
    <div id="format-toolbar">
        <button data-command="bold"><b>B</b></button>
        <button data-command="italic"><i>I</i></button>
        <button data-command="underline"><u>U</u></button>
        <input type="color" data-command="foreColor" title="M√†u ch·ªØ">
    </div>

    <script src="https://api.dmcdn.net/all.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const videoIdInput = document.getElementById('videoId');
            const enTranscriptInput = document.getElementById('enTranscript');
            const viTranscriptInput = document.getElementById('viTranscript');
            const loadDataBtn = document.getElementById('loadData');
            const transcriptContainer = document.getElementById('transcript-container');
            const playerContainer = document.getElementById('player');
            const saveButton = document.getElementById('saveButton');
            const loadFileInput = document.getElementById('loadFile');
            const formatToolbar = document.getElementById('format-toolbar');

            let player;
            let userIsScrolling = false;
            let scrollTimeout;
            let mediaRecorder;
            let audioChunks = [];
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            if(SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.");
            }

            // --- 1. T·∫£i v√† Hi·ªÉn th·ªã ƒê·ªìng b·ªô ---

            const parseTranscript = (text) => {
                const lines = text.trim().split('\n');
                const result = [];
                for (let i = 0; i < lines.length; i += 2) {
                    if (lines[i] && lines[i+1]) {
                        const timeStr = lines[i].trim();
                        const timeInSeconds = timeStr.split(':').reduce((acc, time) => (60 * acc) + +time, 0);
                        result.push({
                            time: timeInSeconds,
                            timeStr: timeStr,
                            text: lines[i+1].trim()
                        });
                    }
                }
                return result;
            };
            
            const displayTranscript = (enData, viData) => {
                transcriptContainer.innerHTML = '';
                if (enData.length === 0) {
                     transcriptContainer.innerHTML = '<p style="text-align: center; color: #888;">Kh√¥ng c√≥ d·ªØ li·ªáu l·ªùi tho·∫°i h·ª£p l·ªá.</p>';
                     return;
                }
                
                enData.forEach((enLine, index) => {
                    const viLine = viData.find(line => line.time === enLine.time) || { text: '' };
                    
                    const item = document.createElement('div');
                    item.className = 'transcript-item';
                    item.dataset.time = enLine.time;
                    
                    item.innerHTML = `
                        <p class="lang-en" data-lang="en">
                            <span>${enLine.text}</span>
                            <span class="pronunciation-tool">
                                ${SpeechRecognition ? '<button class="record-btn" title="Ghi √¢m v√† ch·∫•m ƒëi·ªÉm">üé§</button>' : ''}
                                <span class="result-container"></span>
                            </span>
                        </p>
                        <p class="lang-vi" data-lang="vi"><span>${viLine.text}</span></p>
                    `;
                    
                    transcriptContainer.appendChild(item);
                });
                addTranscriptEventListeners();
            };

            const loadData = () => {
                const videoId = videoIdInput.value.trim();
                if (!videoId) {
                    alert('Vui l√≤ng nh·∫≠p ID Video Dailymotion.');
                    return;
                }

                const enData = parseTranscript(enTranscriptInput.value);
                const viData = parseTranscript(viTranscriptInput.value);

                displayTranscript(enData, viData);
                initializePlayer(videoId);
            };

            loadDataBtn.addEventListener('click', loadData);

            const initializePlayer = (videoId) => {
                if (player) {
                    player.load(videoId);
                } else {
                    player = DM.player(playerContainer, {
                        video: videoId,
                        width: '100%',
                        height: '100%',
                        params: {
                            autoplay: false,
                            mute: false
                        }
                    });
                    
                    player.addEventListener('timeupdate', () => {
                        if (!userIsScrolling) {
                            highlightCurrentLine(player.currentTime);
                        }
                    });
                }
            };

            // --- T·ª± ƒë·ªông theo d√µi v√† ƒë√°nh d·∫•u ---

            transcriptContainer.addEventListener('scroll', () => {
                userIsScrolling = true;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    userIsScrolling = false;
                }, 2000); // T·∫°m d·ª´ng auto-scroll trong 2 gi√¢y sau khi ng∆∞·ªùi d√πng t·ª± cu·ªôn
            });

            const highlightCurrentLine = (currentTime) => {
                const lines = transcriptContainer.querySelectorAll('.transcript-item');
                let currentLine = null;

                for (let i = 0; i < lines.length; i++) {
                    const lineTime = parseFloat(lines[i].dataset.time);
                    const nextLineTime = (i + 1 < lines.length) ? parseFloat(lines[i + 1].dataset.time) : Infinity;

                    if (currentTime >= lineTime && currentTime < nextLineTime) {
                        currentLine = lines[i];
                        break;
                    }
                }
                
                if (currentLine) {
                    const alreadyCurrent = document.querySelector('.transcript-item.current');
                    if (alreadyCurrent && alreadyCurrent !== currentLine) {
                        alreadyCurrent.classList.remove('current');
                    }
                    if (!currentLine.classList.contains('current')) {
                        currentLine.classList.add('current');
                        currentLine.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            };

            // --- 2. T∆∞∆°ng t√°c v·ªõi Video v√† L·ªùi tho·∫°i ---

            function addTranscriptEventListeners() {
                transcriptContainer.querySelectorAll('.transcript-item').forEach(item => {
                    // ƒêi·ªÅu h∆∞·ªõng nhanh
                    item.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && !e.target.closest('[contenteditable="true"]')) {
                           if (player) {
                                const time = parseFloat(item.dataset.time);
                                player.seek(time);
                                player.play();
                                userIsScrolling = false; // K√≠ch ho·∫°t l·∫°i auto-scroll ngay l·∫≠p t·ª©c
                                highlightCurrentLine(time);
                           }
                        }
                    });

                    // Ch·ªânh s·ª≠a tr·ª±c ti·∫øp
                    item.querySelectorAll('.lang-en > span:first-child, .lang-vi > span:first-child').forEach(span => {
                         span.addEventListener('dblclick', () => {
                            span.contentEditable = true;
                            span.focus();
                         });
                         span.addEventListener('blur', () => {
                            span.contentEditable = false;
                            hideFormatToolbar();
                         });
                    });
                });
                
                if (SpeechRecognition) {
                    transcriptContainer.querySelectorAll('.record-btn').forEach(btn => {
                        btn.addEventListener('click', handleRecordClick);
                    });
                }
            }

            // --- ƒê·ªãnh d·∫°ng vƒÉn b·∫£n ---

            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const selectedElement = range.commonAncestorContainer.parentElement;
                    if (selectedElement.closest('[contenteditable="true"]')) {
                        const rect = range.getBoundingClientRect();
                        showFormatToolbar(rect.top - 40, rect.left + rect.width / 2);
                        return;
                    }
                }
                // hideFormatToolbar(); // Can be too aggressive
            });
            
            document.addEventListener('click', (e) => {
                if (!formatToolbar.contains(e.target) && !window.getSelection().toString()) {
                    hideFormatToolbar();
                }
            });

            function showFormatToolbar(top, left) {
                formatToolbar.style.display = 'block';
                formatToolbar.style.top = `${top + window.scrollY}px`;
                formatToolbar.style.left = `${left - formatToolbar.offsetWidth / 2}px`;
            }

            function hideFormatToolbar() {
                formatToolbar.style.display = 'none';
            }

            formatToolbar.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent focus loss from selection
                const target = e.target.closest('button, input');
                if (target) {
                    const command = target.dataset.command;
                    const value = target.type === 'color' ? target.value : null;
                    document.execCommand(command, false, value);
                }
            });
            
            formatToolbar.querySelector('input[type="color"]').addEventListener('input', (e) => {
                 document.execCommand('foreColor', false, e.target.value);
            });


            // --- 3. Luy·ªán ph√°t √¢m ---
            
            function handleRecordClick(event) {
                const btn = event.currentTarget;
                if (btn.classList.contains('recording')) {
                    // Stop recording
                    if(mediaRecorder && mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                    recognition.stop();
                    btn.classList.remove('recording');
                    btn.innerHTML = 'üé§';
                } else {
                    // Start recording
                    const textToMatch = btn.closest('.lang-en').querySelector('span:first-child').innerText.trim();
                    startRecording(btn, textToMatch);
                }
            }
            
            async function startRecording(btn, textToMatch) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    btn.classList.add('recording');
                    btn.innerHTML = 'üõë';

                    const resultContainer = btn.closest('.pronunciation-tool').querySelector('.result-container');
                    resultContainer.innerHTML = '<i>ƒêang nghe...</i>';

                    // Audio recording
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        createListenAgainButton(resultContainer, audioUrl);
                        // Clean up stream resources
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    // Speech recognition
                    recognition.onresult = (event) => {
                        const recognizedText = event.results[0][0].transcript;
                        const score = calculateSimilarity(textToMatch, recognizedText);
                        displayScore(resultContainer, recognizedText, score);
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        resultContainer.innerHTML = `<span style="color: ${var(--danger-color)}">L·ªói: ${event.error}</span>`;
                    };
                    
                    recognition.onend = () => {
                         if(btn.classList.contains('recording')){
                           btn.classList.remove('recording');
                           btn.innerHTML = 'üé§';
                           if(mediaRecorder && mediaRecorder.state === "recording") {
                               mediaRecorder.stop();
                           }
                         }
                    };

                    mediaRecorder.start();
                    recognition.start();

                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    alert('Kh√¥ng th·ªÉ truy c·∫≠p micro. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.');
                    const resultContainer = btn.closest('.pronunciation-tool').querySelector('.result-container');
                    resultContainer.innerHTML = `<span style="color: ${var(--danger-color)}">L·ªói micro</span>`;
                }
            }
            
            function calculateSimilarity(original, recognized) {
                const originalWords = original.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
                const recognizedWords = recognized.toLowerCase().split(/\s+/);
                
                const matches = originalWords.filter(word => recognizedWords.includes(word));
                
                return Math.round((matches.length / originalWords.length) * 100);
            }

            function displayScore(container, recognizedText, score) {
                let color = score > 80 ? 'var(--success-color)' : (score > 50 ? 'var(--warning-color)' : 'var(--danger-color)');
                container.innerHTML = `"${recognizedText}" <span class="score" style="background-color: ${color};">${score}%</span>`;
            }
            
            function createListenAgainButton(container, audioUrl) {
                const existingBtn = container.querySelector('.listen-again-btn');
                if(existingBtn) existingBtn.remove();
                
                const listenBtn = document.createElement('button');
                listenBtn.className = 'listen-again-btn';
                listenBtn.textContent = 'Nghe l·∫°i üéß';
                listenBtn.onclick = () => {
                    const audio = new Audio(audioUrl);
                    audio.play();
                };
                container.appendChild(listenBtn);
            }

            // --- 4. L∆∞u v√† M·ªü l·∫°i phi√™n l√†m vi·ªác ---

            saveButton.addEventListener('click', () => {
                const lines = [];
                transcriptContainer.querySelectorAll('.transcript-item').forEach(item => {
                    lines.push({
                        time: parseFloat(item.dataset.time),
                        en: item.querySelector('.lang-en span:first-child').innerHTML,
                        vi: item.querySelector('.lang-vi span').innerHTML
                    });
                });

                const sessionData = {
                    videoId: videoIdInput.value,
                    transcript: lines,
                    raw: {
                        en: enTranscriptInput.value,
                        vi: viTranscriptInput.value
                    }
                };
                
                const dataStr = JSON.stringify(sessionData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `session_${videoIdInput.value || 'data'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            loadFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        videoIdInput.value = data.videoId || '';
                        enTranscriptInput.value = data.raw ? data.raw.en : '';
                        viTranscriptInput.value = data.raw ? data.raw.vi : '';
                        
                        // Regenerate transcript from saved edits
                        transcriptContainer.innerHTML = '';
                        data.transcript.forEach(line => {
                             const item = document.createElement('div');
                             item.className = 'transcript-item';
                             item.dataset.time = line.time;
                             item.innerHTML = `
                                <p class="lang-en" data-lang="en">
                                    <span>${line.en}</span>
                                    <span class="pronunciation-tool">
                                        ${SpeechRecognition ? '<button class="record-btn" title="Ghi √¢m v√† ch·∫•m ƒëi·ªÉm">üé§</button>' : ''}
                                        <span class="result-container"></span>
                                    </span>
                                </p>
                                <p class="lang-vi" data-lang="vi"><span>${line.vi}</span></p>
                            `;
                             transcriptContainer.appendChild(item);
                        });

                        addTranscriptEventListeners();
                        initializePlayer(data.videoId);
                        
                    } catch (error) {
                        alert('L·ªói: T·ªáp tin JSON kh√¥ng h·ª£p l·ªá.');
                        console.error("Error parsing JSON:", error);
                    }
                };
                reader.readAsText(file);
                loadFileInput.value = ''; // Reset input to allow loading the same file again
            });

        });
    </script>
</body>
</html>
