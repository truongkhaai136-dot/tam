<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Dailymotion Transcript Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0 15px; }
        .container { max-width: 800px; margin: 20px auto; }
        #player-container { position: relative; width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */ background-color: #000; margin-bottom: 15px; }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .line { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; position: relative; }
        .line:hover { background-color: #eef; }
        .user { font-weight: bold; }
        .machine { color: gray; margin-left: 10px; }
        .line[contenteditable="true"] { background-color: #ffffcc; outline: 1px dashed #999; }
        .highlight { background-color: #d1ecf1 !important; }
        .record-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #2196f3; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .result { margin-top: 5px; font-size: 13px; }
        #toolbar { display: none; position: absolute; background: #fff; border: 1px solid #ccc; padding: 5px; z-index: 1000; }
        textarea { width: 100%; box-sizing: border-box; }
        button { margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dailymotion Transcript Tool</h1>
        <label>üîó Dailymotion Video URL:
            <input id="videoUrlInput" style="width: 400px;" type="text" value="" />
        </label><br /><br />
        <label>üìù English Transcript (ƒë·ªãnh d·∫°ng: `ph√∫t:gi√¢y\nn·ªôi dung`): <textarea id="scriptEN" rows="6"></textarea></label><br /><br />
        <label>üáªüá≥ Vietnamese Transcript (ƒë·ªãnh d·∫°ng: `ph√∫t:gi√¢y\nn·ªôi dung`): <textarea id="scriptVI" rows="6"></textarea></label><br /><br />
        <button onclick="loadVideoAndTranscript()">‚ñ∂Ô∏è Load Video + Transcript</button>
        <button onclick="saveScripts()">üíæ Save Script</button>
        <br /><br />
        <label>üìÇ Load Saved Script (.json):
            <input type="file" id="loadFileInput" accept=".json" onchange="loadScriptFile(event)">
        </label>
        
        <div id="player-container">
            <div id="player"></div>
        </div>
        
        <h3>Transcript (EN + VI)</h3>
        <div id="toolbar">
            <button onclick="execCmd('bold')"><b>B</b></button>
            <button onclick="execCmd('italic')"><i>I</i></button>
            <button onclick="execCmd('underline')"><u>U</u></button>
            <input onchange="execCmd('foreColor', this.value)" type="color" />
        </div>
        <div id="transcript"></div>
    </div>
    <button id="togglePause" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 10px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Play</button>

    <script>
        // --- BI·∫æN TR·∫†NG TH√ÅI TO√ÄN C·ª§C ---
        let playerIframe = null;
        let transcriptData = [];
        let isPlayerReady = false;
        let currentTime = 0;
        let isPlaying = false;
        let userScrolling = false;
        let scrollTimeout = null;

        // --- GIAO TI·∫æP V·ªöI PLAYER ---

        // 1. L·∫Øng nghe m·ªçi tin nh·∫Øn t·ª´ Dailymotion
        window.addEventListener('message', (event) => {
            if (event.origin !== "https://www.dailymotion.com") return;
            const data = Object.fromEntries(new URLSearchParams(event.data));

            if (data.event === 'apiready') isPlayerReady = true;
            if (data.event === 'play' || data.event === 'playing') {
                if (!isPlaying) {
                    isPlaying = true;
                    onPlayerPlay();
                }
            }
            if (data.event === 'pause' || data.event === 'end') {
                if (isPlaying) {
                    isPlaying = false;
                    onPlayerPause();
                }
            }
            if (data.event === 'timeupdate') {
                currentTime = parseFloat(data.time);
            }
        });

        // 2. G·ª≠i l·ªánh ƒë·∫øn player
        function postPlayerMessage(message) {
            if (playerIframe && isPlayerReady) {
                playerIframe.contentWindow.postMessage(message, '*');
            }
        }

        // --- C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN & T∆Ø∆†NG T√ÅC ---
        document.getElementById('togglePause').onclick = () => {
            postPlayerMessage(isPlaying ? 'pause' : 'play');
        };

        function onPlayerPlay() {
            document.getElementById('togglePause').textContent = 'Pause';
            requestAnimationFrame(trackCurrentLine);
        }

        function onPlayerPause() {
            document.getElementById('togglePause').textContent = 'Play';
        }

        function trackCurrentLine() {
            if (!isPlaying) return;

            let currentId = null;
            // T√¨m d√≤ng transcript cu·ªëi c√πng c√≥ th·ªùi gian <= th·ªùi gian hi·ªán t·∫°i c·ªßa video
            for (const line of transcriptData) {
                if (currentTime >= line.time) {
                    currentId = line.id;
                } else {
                    break;
                }
            }
            
            document.querySelectorAll('.line').forEach(el => el.classList.remove('highlight'));
            if (currentId) {
                const activeEl = document.getElementById(currentId);
                if (activeEl && !activeEl.classList.contains('highlight')) {
                    activeEl.classList.add('highlight');
                    if (!userScrolling) {
                        activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
            requestAnimationFrame(trackCurrentLine);
        }

        // --- KH·ªûI T·∫†O V√Ä D·ª∞NG GIAO DI·ªÜN ---
        function parseDailymotionUrl(url) {
            const match = url.match(/(?:dailymotion\.com\/(?:video|embed\/video)\/|dai\.ly\/)([a-zA-Z0-9]+)/);
            return match ? match[1] : null;
        }

        function loadVideoAndTranscript() {
            const videoUrl = document.getElementById('videoUrlInput').value.trim();
            const videoId = parseDailymotionUrl(videoUrl);
            if (!videoId) {
                alert('URL Dailymotion kh√¥ng h·ª£p l·ªá.');
                return;
            }

            // Reset
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = '';
            playerIframe = null;
            isPlayerReady = false;
            currentTime = 0;
            isPlaying = false;
            onPlayerPause(); 

            // T·∫°o player
            const iframe = document.createElement('iframe');
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
            iframe.setAttribute('src', `https://www.dailymotion.com/embed/video/${videoId}?api=postMessage`);
            playerDiv.appendChild(iframe);
            playerIframe = iframe;
            
            renderTranscript();
        }

        function renderTranscript() {
            const rawEN = document.getElementById('scriptEN').value.trim();
            const rawVI = document.getElementById('scriptVI').value.trim();
            const enData = parseTranscript(rawEN);
            const viData = parseTranscript(rawVI);
            const transcriptEl = document.getElementById('transcript');
            transcriptEl.innerHTML = '';
            transcriptData = [];
            
            const combinedData = [...enData.map(d => ({...d, lang: 'en'})), ...viData.map(d => ({...d, lang: 'vi'}))];
            combinedData.sort((a, b) => a.time - b.time);

            combinedData.forEach((line, index) => {
                const lineId = `${line.lang}_${index}`;
                transcriptData.push({ id: lineId, time: line.time });
                const prefix = line.lang === 'en' ? `[${formatTime(line.time)}]` : '[VI]';
                const className = line.lang === 'en' ? 'user' : 'machine';
                const div = createLineCard(lineId, line.time, `${prefix} ${line.text}`, className);
                transcriptEl.appendChild(div);
            });
        }
        
        function createLineCard(id, time, text, className) {
            const div = document.createElement('div');
            div.className = `line ${className}`;
            div.id = id;
            div.onclick = () => postPlayerMessage(`seek=${time}`);
            
            const textNode = document.createTextNode(text);
            div.appendChild(textNode);
            
            if (className === 'user') {
                div.ondblclick = () => { div.contentEditable = true; div.focus(); };
                div.onblur = () => { div.contentEditable = false; };
                const btn = document.createElement('button');
                btn.className = 'record-btn';
                btn.textContent = 'üé§';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const expectedText = div.textContent.replace(/\[\d+:\d{2}\]\s*/, '').replace('üé§', '').trim();
                    startSpeechRecognition(div, expectedText);
                };
                div.appendChild(btn);
            }
            return div;
        }

        // --- C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC (gi·ªØ nguy√™n) ---
        function formatTime(totalSeconds) { const minutes = Math.floor(totalSeconds / 60); const seconds = (totalSeconds % 60).toString().padStart(2, '0'); return `${minutes}:${seconds}`; }
        function parseTranscript(raw) { const blocks = raw.trim().split(/\n\s*\n/); const parsed = []; for(const block of blocks){ const lines = block.split('\n'); if(lines.length < 2) continue; const timeMatch = lines[0].match(/^(\d+):(\d{2})$/); if(!timeMatch) continue; const time = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]); const text = lines.slice(1).join('<br>'); parsed.push({time, text}); } return parsed; }
        document.getElementById('transcript').addEventListener('wheel', () => { userScrolling = true; clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => userScrolling = false, 3000); });
        document.addEventListener('mouseup', e => { const sel = window.getSelection(); if (sel.toString().length > 0 && sel.getRangeAt(0).startContainer.parentNode.classList.contains('line')) { const rect = sel.getRangeAt(0).getBoundingClientRect(); const toolbar = document.getElementById('toolbar'); toolbar.style.top = `${window.scrollY + rect.top - 40}px`; toolbar.style.left = `${window.scrollX + rect.left}px`; toolbar.style.display = 'block'; } else { document.getElementById('toolbar').style.display = 'none'; } });
        function execCmd(cmd, value = null) { document.execCommand(cmd, false, value); }
        function startSpeechRecognition(div, expectedText) { const oldResult = div.querySelector('.result'); if (oldResult) oldResult.remove(); const oldPlayback = div.querySelector('.playback-container'); if (oldPlayback) oldPlayback.remove(); if (!('webkitSpeechRecognition' in window) || !navigator.mediaDevices) { alert('Speech recognition or recording not supported in this browser'); return; } navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { const mediaRecorder = new MediaRecorder(stream); const audioChunks = []; mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); }; mediaRecorder.onstop = () => { const audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); const audioUrl = URL.createObjectURL(audioBlob); const playbackContainer = document.createElement('div'); playbackContainer.className = 'playback-container'; const listenButton = document.createElement('button'); listenButton.textContent = '‚ñ∂Ô∏è Listen Again'; listenButton.style.marginTop = '5px'; listenButton.onclick = () => new Audio(audioUrl).play(); playbackContainer.appendChild(listenButton); div.appendChild(playbackContainer); }; mediaRecorder.start(); const recognition = new webkitSpeechRecognition(); recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1; recognition.onend = () => { mediaRecorder.stop(); stream.getTracks().forEach(track => track.stop()); }; recognition.onresult = function(event) { const spokenText = event.results[0][0].transcript; const score = similarity(spokenText.toLowerCase(), expectedText.replace(/<br>/g, ' ').toLowerCase()); const resultEl = document.createElement('div'); resultEl.className = 'result'; resultEl.innerHTML = `You said: "<em>${spokenText}</em>" ‚Üí Similarity: <b>${Math.round(score * 100)}%</b>`; div.appendChild(resultEl); }; recognition.onerror = function(event) { alert('Error occurred in recognition: ' + event.error); mediaRecorder.stop(); }; recognition.start(); }).catch(err => { alert('Could not access the microphone. Please grant permission.'); console.error("Error accessing microphone:", err); }); }
        function similarity(s1, s2) { const longer = s1.length > s2.length ? s1 : s2; const shorter = s1.length > s2.length ? s2 : s1; const longerLength = longer.length; if (longerLength === 0) return 1.0; return (longerLength - editDistance(longer, shorter)) / longerLength; }
        function editDistance(s1, s2) { s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = []; for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i === 0) costs[j] = j; else if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length]; }
        function saveScripts() { const videoUrl = document.getElementById('videoUrlInput').value.trim(); let enText = document.getElementById('scriptEN').value; let viText = document.getElementById('scriptVI').value; const blob = new Blob([JSON.stringify({ videoUrl, enText, viText }, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `transcript_${videoUrl.split('/').pop() || 'video'}.json`; a.click(); URL.revokeObjectURL(url); }
        function loadScriptFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); document.getElementById('videoUrlInput').value = data.videoUrl || ''; document.getElementById('scriptEN').value = data.enText || ''; document.getElementById('scriptVI').value = data.viText || ''; } catch (err) { alert('Invalid JSON file.'); } }; reader.readAsText(file); }
    </script>
</body>
</html>
